<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Prescripciones de Obra v3.0 - Pamesa Cerámica</title>
    
    <!-- LIBRERÍAS EXTERNAS -->
    <!-- Fuente Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Librería jsPDF para generar el PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --color-principal: #ce1719;
            --color-principal-hover: #b51517;
            --color-secundario: #4a4a4a;
            --color-secundario-hover: #333333;
            --color-blanco: #ffffff;
            --color-texto-principal: #222;
            --color-texto-secundario: #555;
            --color-titulos: #000;
            --color-fondo: #f9fafb;
            --color-fondo-suave: #f8f8f8;
            --color-borde-suave: #e5e5e5;
            --font-main: 'Montserrat', sans-serif;
            --radio-borde: 8px;
            --sombra-suave: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --max-width-container: 1600px;
        }

        /* --- ESTILOS BASE Y RESET --- */
        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-main);
            background-color: var(--color-fondo);
            color: var(--color-texto-principal);
            margin: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- CABECERA --- */
        .header-corporativo {
            background-color: var(--color-blanco);
            padding: 15px 30px;
            border-bottom: 1px solid var(--color-borde-suave);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            z-index: 10;
            flex-shrink: 0;
        }
        .header-container {
            max-width: var(--max-width-container);
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-corporativo img { height: 35px; width: auto; }
        .header-corporativo h1 {
            font-size: 1.4em; color: var(--color-titulos);
            font-weight: 600; margin: 0; text-align: right;
        }
        
        /* --- ESTRUCTURA PRINCIPAL --- */
        .main-content { 
            padding: 30px; 
            flex-grow: 1;
            overflow: hidden;
            display: flex;
        }
        .container {
            display: flex; gap: 30px;
            max-width: var(--max-width-container);
            margin: 0 auto;
            width: 100%;
            height: 100%;
        }
        .panel {
            background-color: var(--color-blanco);
            border-radius: var(--radio-borde);
            box-shadow: var(--sombra-suave);
            border: 1px solid var(--color-borde-suave);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .formulario-panel { flex: 1; min-width: 0px; max-width: 500px; }
        .resultado-panel { flex: 2; min-width: 0; }
        
        .panel-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--color-borde-suave);
            flex-shrink: 0;
            background-color: var(--color-blanco);
        }
        .panel-body {
            padding: 30px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .panel-body::-webkit-scrollbar { width: 8px; }
        .panel-body::-webkit-scrollbar-track { background: var(--color-fondo-suave); }
        .panel-body::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 20px; border: 2px solid var(--color-fondo-suave); }
        .panel-body::-webkit-scrollbar-thumb:hover { background-color: #bbb; }


        /* --- ESTILOS FORMULARIO --- */
        #formulario-busqueda {
            padding: 30px;
            overflow-y: auto;
            flex-grow: 1;
        }
        #formulario-campos {
            padding: 30px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        fieldset {
            border: 1px solid var(--color-borde-suave);
            border-radius: var(--radio-borde);
            padding: 20px;
            margin: 0 0 25px 0;
        }
        legend {
            font-weight: 600; font-size: 1.1em;
            color: var(--color-principal);
            padding: 0 10px; margin-left: -10px;
        }
        .campo { margin-bottom: 15px; }
        .campo label {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 6px;
            font-weight: 500; font-size: 0.85em;
            color: var(--color-texto-secundario);
        }
        .campo input, .campo select {
            width: 100%; padding: 12px;
            border: 1px solid var(--color-borde-suave);
            border-radius: 6px; background-color: #fff;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: var(--font-main); font-size: 0.95em;
        }
        .campo input[readonly] {
            background-color: var(--color-fondo-suave);
            color: var(--color-texto-secundario);
            cursor: not-allowed;
            border-style: dashed;
        }
        .campo input:focus, .campo select:focus {
            outline: none; border-color: var(--color-principal);
            box-shadow: 0 0 0 3px rgba(206, 23, 25, 0.15);
        }
        .buscador-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 10px;
        }
        
        .filtros-rapidos { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .filtros-rapidos .filtro-toggle-label {
            display: inline-block; padding: 8px 16px; border: 1px solid var(--color-borde-suave);
            border-radius: 20px; font-size: 0.85em; font-weight: 500; cursor: pointer; transition: all 0.2s ease-in-out;
            background-color: var(--color-fondo-suave); color: var(--color-texto-secundario);
        }
        .filtros-rapidos .filtro-toggle-input { display: none; }
        .filtros-rapidos .filtro-toggle-input:checked + .filtro-toggle-label {
            background-color: var(--color-principal); color: var(--color-blanco); border-color: var(--color-principal);
        }
        .filtros-rapidos .filtro-toggle-label:hover { border-color: var(--color-secundario); }
        
        .filtros-avanzados-toggle {
            background: none; border: none; padding: 5px 0; color: var(--color-principal);
            font-weight: 600; cursor: pointer; font-size: 0.9em; margin-bottom: 15px;
        }
        .filtros-avanzados-toggle::after { content: ' ▼'; }
        .filtros-avanzados-toggle.open::after { content: ' ▲'; }
        .filtros-avanzados-content { display: none; padding-top: 10px; border-top: 1px solid var(--color-borde-suave); }
        #buscador-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        #status-message { 
            margin-top: 20px; 
            padding: 10px;
            font-weight: 600;
            text-align: center;
            border-radius: var(--radio-borde);
            background-color: var(--color-fondo-suave);
            border: 1px solid var(--color-borde-suave);
            color: var(--color-texto-principal); 
        }

        /* --- PANEL RESULTADOS Y NUEVOS ESTILOS --- */
        .resultado-panel .panel-body {
            display: flex;
            flex-direction: column;
            gap: 25px;
            padding-top: 15px;
        }

        #product-results-list {
            flex-shrink: 0;
            height: 280px; /* Altura fija para la lista de resultados */
            overflow-y: auto;
            border: 1px solid var(--color-borde-suave);
            border-radius: var(--radio-borde);
            background: #fff;
        }

        .product-card {
            padding: 15px 20px;
            border-bottom: 1px solid var(--color-borde-suave);
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .product-card:last-child { border-bottom: none; }
        .product-card:hover { background-color: #f7f7f7; }
        .product-card.selected {
            background-color: #fdeaea;
            border-left: 4px solid var(--color-principal);
            padding-left: 16px;
        }
        .card-title {
            font-weight: 700;
            font-size: 1em;
            color: var(--color-texto-principal);
            margin: 0 0 5px 0;
        }
        .card-differentiators {
            font-size: 0.9em;
            color: var(--color-texto-secundario);
            margin-bottom: 10px;
        }
        .card-specs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .spec-tag {
            background-color: var(--color-fondo-suave);
            border: 1px solid var(--color-borde-suave);
            color: var(--color-texto-secundario);
            font-size: 0.75em;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .resultado-acciones {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            gap: 20px;
        }
        .acciones-titulo {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--color-texto-principal); margin: 0;
        }
        .grupo-botones { display: flex; flex-wrap: wrap; gap: 10px; }
        .btn-accion, .link-accion {
            background-color: var(--color-principal); color: white; border: none; padding: 10px 20px; border-radius: 6px;
            cursor: pointer; font-weight: 600; font-family: var(--font-main); font-size: 0.9em; text-decoration: none;
            display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .btn-accion:hover, .link-accion:hover {
            background-color: var(--color-principal-hover); transform: translateY(-2px); color: white;
            box-shadow: 0 4px 10px rgba(206, 23, 25, 0.2);
        }
        .btn-accion:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-accion.secundario, .link-accion.secundario { background-color: var(--color-secundario); }
        .btn-accion.secundario:hover, .link-accion.secundario:hover {
             background-color: var(--color-secundario-hover); box-shadow: 0 4px 10px rgba(74, 74, 74, 0.2);
        }
        .btn-limpiar {
            background-color: transparent; color: var(--color-principal); border: 1px solid var(--color-principal);
            padding: 8px 16px; font-size: 0.85em; font-weight: 600; cursor: pointer; border-radius: 6px; transition: all 0.2s;
        }
        .btn-limpiar:hover { background-color: var(--color-principal); color: var(--color-blanco); }

        /* --- IMAGEN Y PLACEHOLDER --- */
        #imagen-producto-container {
            flex-shrink: 0;
        }
        .image-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        #image-placeholder {
            width: 100%; height: 250px; border-radius: var(--radio-borde);
            background-color: var(--color-fondo-suave); border: 2px dashed var(--color-borde-suave);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: var(--color-texto-secundario); text-align: center;
        }
        #image-placeholder svg { width: 48px; height: 48px; margin-bottom: 10px; opacity: 0.5; }
        #imagen-producto {
            max-width: 100%; max-height: 300px; height: auto; border-radius: 0px;
            border: 1px solid var(--color-borde-suave); box-shadow: var(--sombra-suave); object-fit: cover;
        }

        /* --- TEXTO Y ESTADO VACÍO --- */
        #texto-generado {
            white-space: pre-wrap; word-wrap: break-word;
            font-family: var(--font-main);
            background-color: #fdfdfd; padding: 25px; border-radius: var(--radio-borde);
            border: 1px solid var(--color-borde-suave);
            font-size: 0.95em; line-height: 1.8; color: #333;
            overflow-y: auto;
            flex-grow: 1;
        }
        #empty-state {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: var(--color-texto-secundario);
            background-color: #fdfdfd; padding: 50px 25px; border-radius: var(--radio-borde);
            border: 1px solid var(--color-borde-suave);
            min-height: 200px;
            flex-grow: 1;
        }
        #empty-state svg { width: 60px; height: 60px; margin-bottom: 15px; opacity: 0.4; }
        #empty-state h3 { margin: 0 0 10px 0; color: var(--color-texto-principal); }
        
        .resaltado { color: var(--color-principal); font-weight: 600; }
        
        .oculto { display: none !important; }

        /* --- RESPONSIVIDAD --- */
        @media (max-width: 1100px) {
            body { height: auto; overflow: visible; }
            .main-content { padding: 20px 15px; height: auto; }
            .container { flex-direction: column; height: auto; }
            .formulario-panel { max-width: 100%; }
            .panel { overflow: visible; }
            .panel-body, #formulario-busqueda { overflow: visible; }
            #product-results-list { height: 250px; }
        }
        @media (max-width: 768px) {
            .header-corporativo { padding: 15px; }
            .main-content { padding: 20px 15px; }
            .panel, .panel-header, .panel-body, #formulario-busqueda, #formulario-campos { padding: 20px; }
            .header-corporativo h1 { font-size: 1.1em; }
            .header-corporativo img { height: 30px; }
            .resultado-acciones { flex-direction: column; align-items: flex-start; gap: 15px; }
            .grupo-botones { width: 100%; }
            .btn-accion, .link-accion { flex-grow: 1; text-align: center; }
        }
        @media (max-width: 600px) {
            .header-container { flex-direction: column; gap: 10px; }
            .header-corporativo h1 { text-align: center; }
            .grupo-dimensiones { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="header-corporativo">
        <div class="header-container">
            <img src="LOGO-PAMESA.jpg" alt="Logo Pamesa Cerámica" onerror="this.style.display='none'">
            <h1>Generador de Prescripciones de Obra v3.0</h1>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="panel formulario-panel">
                <div id="formulario-busqueda">
                    <fieldset style="margin: 0; padding:0; border: none;">
                        <div class="buscador-header">
                            <legend>Asistente de Producto</legend>
                            <button type="button" id="btn-clear-filters" class="btn-limpiar">Limpiar Filtros</button>
                        </div>
                        
                        <div class="campo">
                            <label>Características Especiales</label>
                            <div class="filtros-rapidos">
                                <div><input type="checkbox" id="filtro-20mm" class="filtro-toggle-input"><label for="filtro-20mm" class="filtro-toggle-label">20mm Espesor</label></div>
                                <div><input type="checkbox" id="filtro-ext" class="filtro-toggle-input"><label for="filtro-ext" class="filtro-toggle-label">Acabado EXT</label></div>
                                <div><input type="checkbox" id="filtro-dup" class="filtro-toggle-input"><label for="filtro-dup" class="filtro-toggle-label">Modelo DUP</label></div>
                            </div>
                        </div>

                        <div id="filtros-principales">
                             <div class="campo"><label for="search-serie">Serie</label><select id="search-serie" data-csv-col="Serie" disabled><option value="">Todas</option></select></div>
                             <div class="campo"><label for="search-efecto">Efecto</label><select id="search-efecto" data-csv-col="Efecto" disabled><option value="">Todos</option></select></div>
                             <div class="campo"><label for="search-color">Color</label><select id="search-color" data-csv-col="COLOR" disabled><option value="">Todos</option></select></div>
                        </div>

                        <div class="filtros-avanzados-container">
                             <button type="button" id="filtros-avanzados-toggle" class="filtros-avanzados-toggle">Más filtros</button>
                             <div id="filtros-avanzados-content" class="filtros-avanzados-content">
                                <div id="buscador-grid">
                                    <div class="campo"><label for="search-formato">Formato</label><select id="search-formato" data-csv-col="FORMATO" disabled><option value="">Todos</option></select></div>
                                    <div class="campo"><label for="search-modelo">Modelo</label><select id="search-modelo" data-csv-col="MODELO" disabled><option value="">Todos</option></select></div>
                                    <div class="campo"><label for="search-familia">Tipo Material</label><select id="search-familia" data-csv-col="Desc_Familia_web" disabled><option value="">Todos</option></select></div>
                                    <div class="campo"><label for="search-resbaladicidad">Clase Resbaladicidad</label><select id="search-resbaladicidad" data-csv-col="en_16165_anexo_c_deslizamiento_pendulo" disabled><option value="">Todas</option></select></div>
                                </div>
                             </div>
                        </div>
                        
                        <p id="status-message">Cargando datos...</p>
                    </fieldset>
                </div>
                
                <div id="formulario-campos" class="oculto">
                    <form id="formulario-prescripcion">
                        <fieldset>
                            <legend>4. Materiales de Colocación (Editable)</legend>
                            <div class="campo"><label for="adhesivo_nombre">Nombre del Adhesivo</label><input type="text" id="adhesivo_nombre" value="MARCA ADHESIVO"></div>
                            <div class="campo"><label for="adhesivo_fabricante">Fabricante del Adhesivo</label><input type="text" id="adhesivo_fabricante" value="NOMBRE FABRICANTE"></div>
                            <div class="campo"><label for="adhesivo_tipo">Tipo de Adhesivo (EN 12004)</label><input type="text" id="adhesivo_tipo" value=""></div>
                            <div class="campo"><label for="mortero_nombre">Nombre del Mortero de Juntas</label><input type="text" id="mortero_nombre" value="MARCA MORTERO"></div>
                            <div class="campo"><label for="mortero_fabricante">Fabricante del Mortero</label><input type="text" id="mortero_fabricante" value="NOMBRE FABRICANTE"></div>
                        </fieldset>

                        <fieldset>
                            <legend>5. Detalles de Ejecución (Editable)</legend>
                            <div class="campo"><label for="junta_maxima">Ancho máximo de junta (mm)</label><input type="number" id="junta_maxima" value="15"></div>
                            <div class="campo"><label for="junta_perimetral">Ancho mínimo junta perimetral (mm)</label><input type="number" id="junta_perimetral" value="5"></div>
                        </fieldset>

                        <!-- CAMPOS OCULTOS PARA ALMACENAR DATOS DEL PRODUCTO -->
                        <input type="hidden" id="tipo_material"><input type="hidden" id="fabricante" value="PAMESA CERÁMICA"><input type="hidden" id="coleccion"><input type="hidden" id="color"><input type="hidden" id="aspecto"><input type="hidden" id="dim_ancho"><input type="hidden" id="dim_alto"><input type="hidden" id="dim_espesor"><input type="hidden" id="desviacion" value="0,15%"><input type="hidden" id="norma_dimensiones" value="UNE-EN ISO10545-2, ISO 13006:2018 UNE-EN 14411:2016"><input type="hidden" id="destonificado"><input type="hidden" id="absorcion_agua"><input type="hidden" id="clase_resbaladicidad"><input type="hidden" id="valor_rd"><input type="hidden" id="uso_transito" value="tránsito intenso"><input type="hidden" id="resistencia_manchas"><input type="hidden" id="resistencia_quimica"><input type="hidden" id="modulo_rotura"><input type="hidden" id="carga_rotura">
                    </form>
                </div>
            </div>
            <div class="panel resultado-panel">
                <div class="panel-header">
                    <div class="resultado-acciones">
                        <h4 class="acciones-titulo">Resultado</h4>
                        <div class="grupo-botones">
                            <button id="btn-copiar" class="btn-accion">Copiar Texto</button>
                            <button id="btn-descargar-txt" class="btn-accion">Descargar .txt</button>
                            <button id="btn-descargar-pdf" class="btn-accion">Descargar PDF</button>
                            <a id="link-dap" href="#" target="_blank" class="link-accion secundario">Ver DAP</a>
                            <a id="link-dop" href="#" target="_blank" class="link-accion secundario">Ver DoP</a>
                            <a href="https://www.pamesa.com/ERP/4.0/empresas/151/045/ficheros/t00030006/44/RECOMENDACIONES_PARA_LA_INSTALACION_DE_PRODUCTOS_CERAMICOS__PGEv3.pdf" target="_blank" class="link-accion secundario">Recomendaciones</a>
                            <a href="https://www.pamesa.com/ERP/4.0/empresas/151/045/ficheros/t00030006/99/Pamesa_I_ES-Baldosa_2024.pdf" target="_blank" class="link-accion secundario">Seguridad</a>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                     <div id="product-results-list">
                        <!-- Las tarjetas de producto se generarán aquí -->
                     </div>

                    <div id="imagen-producto-container" class="oculto">
                         <div class="image-wrapper">
                             <div id="image-placeholder">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                 <span>Pasa el ratón sobre un producto para previsualizar</span>
                             </div>
                            <img id="imagen-producto" src="" alt="Imagen del producto seleccionado" class="oculto">
                            <button id="btn-descargar-imagen" class="btn-accion secundario oculto">Descargar Imagen</button>
                         </div>
                    </div>
                    
                    <div id="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <h3>Bienvenido al Asistente de Prescripciones</h3>
                        <p>Utiliza los filtros de la izquierda para encontrar el producto ideal.<br>Los resultados aparecerán aquí al instante.</p>
                    </div>

                    <pre id="texto-generado" class="oculto"></pre>
                </div>
            </div>
        </div>
    </main>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMENTOS DEL DOM ---
    const ui = {
        formulario: document.getElementById('formulario-prescripcion'),
        camposEditablesContainer: document.getElementById('formulario-campos'),
        output: document.getElementById('texto-generado'),
        emptyState: document.getElementById('empty-state'),
        productResultsList: document.getElementById('product-results-list'),
        imageContainer: document.getElementById('imagen-producto-container'),
        statusMessage: document.getElementById('status-message'),
        btnClearFilters: document.getElementById('btn-clear-filters'),
        advancedFiltersToggle: document.getElementById('filtros-avanzados-toggle'),
        advancedFiltersContent: document.getElementById('filtros-avanzados-content'),
        btnCopiar: document.getElementById('btn-copiar'),
        btnDescargarTxt: document.getElementById('btn-descargar-txt'),
        btnDescargarPdf: document.getElementById('btn-descargar-pdf'),
        linkDAP: document.getElementById('link-dap'),
        linkDOP: document.getElementById('link-dop'),
        imagePlaceholder: document.getElementById('image-placeholder'),
        imagenProducto: document.getElementById('imagen-producto'),
        btnDescargarImagen: document.getElementById('btn-descargar-imagen'),
        quickFilters: Array.from(document.querySelectorAll('.filtro-toggle-input')),
        allSelectFilters: Array.from(document.querySelectorAll('select[data-csv-col]')).reduce((acc, select) => {
            acc[select.dataset.csvCol] = select;
            return acc;
        }, {})
    };

    // --- ESTADO DE LA APLICACIÓN ---
    let csvData = [];
    let selectedProductIndex = null;
    const revestimientoTypes = [
        'Revestimiento pasta blanca no rectificada',
        'Revestimiento pasta roja no rectificado',
        'Revestimiento pasta blanca rectificada'
    ];
    
    // Plantillas
    const pavimentoTemplate = `Suministro y ejecución de pavimento con <span class="resaltado">{tipo_material}</span>, de aspecto <span class="resaltado">{aspecto}</span>, colección <span class="resaltado">{coleccion}</span>, color <span class="resaltado">{color}</span> de <span class="resaltado">{fabricante}</span>. Conformado por prensado en seco, tratado en monococción a temperatura de 1200ºC.\n\nCerámica con dimensiones nominales de (Ancho x Alto x Espesor) <span class="resaltado">{dim_ancho}</span>x<span class="resaltado">{dim_alto}</span>x<span class="resaltado">{dim_espesor}</span> cm, desviación de longitud/anchura, rectitud de lados, ortogonalidad y planimetría inferior a <span class="resaltado">{desviacion}</span> (<span class="resaltado">{norma_dimensiones}</span>).\n\nDestonificado <span class="resaltado">{destonificado}</span>, con una absorción de agua muy baja <span class="resaltado">{absorcion_agua}</span> según ISO 10545-3. Clasificación de suelos según su resbaladicidad <span class="resaltado">{clase_resbaladicidad}</span> (CTE DBSUA), resistencia al deslizamiento <span class="resaltado">{valor_rd}</span> (UNE 41901:2017 EX). Módulo de rotura <span class="resaltado">{modulo_rotura}</span> (ISO-13006:2018 UNE-EN 14411:2016) y carga de rotura <span class="resaltado">{carga_rotura}</span> según ISO10545-4.\n\nPavimento de <span class="resaltado">{uso_transito}</span> conforme a la clasificación de baldosas según uso de la Guía de la Baldosa Cerámica (Documento reconocido DRB 01/11), resistente al choque térmico, al cuarteo, a la helada, a las manchas <span class="resaltado">{resistencia_manchas}</span>, según ISO 10545-14 y a los ataques químicos: <span class="resaltado">{resistencia_quimica}</span>, según ISO 10545-13.\n\nContribuye a los estándares de construcción sostenible y saludable (LEED, BREEAM, WELL) gracias a disponer de Declaración Ambiental de Producto propia (DAP), no ser una fuente emisora de sustancias peligrosas COV’s ni formaldehidos, así como por disponer de contenido de material reciclado >6%. Disponible marcado CE.\n\nCerámica recibida sobre recrecido cementoso sin calefacción radiante (no incluido), apto para la colocación en capa fina y tránsito previsto, con adhesivo de altas prestaciones con excelente adherencia y deformabilidad, <span class="resaltado">{adhesivo_nombre}</span> de <span class="resaltado">{adhesivo_fabricante}</span>, tipo <span class="resaltado">{adhesivo_tipo}</span>, según EN 12004, prescrito de acuerdo a las indicaciones de la UNE 138002 y rejuntadas con mortero de juntas cementoso de fraguado y endurecimiento rápido, <span class="resaltado">{mortero_nombre}</span> de <span class="resaltado">{mortero_fabricante}</span>, según EN 13888, para juntas de hasta <span class="resaltado">{junta_maxima}</span>mm.\n\nI/p.p medios auxiliares. Utilización de p/p de Crucetas Autonivelantes (no incluidas), formación de juntas perimetrales continuas, de anchura no menor de <span class="resaltado">{junta_perimetral}</span> mm, en los límites con paredes, pilares exentos y elevaciones de nivel y, en su caso, juntas de partición intermedias. Respetar juntas estructurales existentes en el soporte. Incluso limpieza y comprobación del grado de humedad de la base. Replanteo de niveles. Replanteo de la disposición de las baldosas y juntas de movimiento. Aplicación del adhesivo. Colocación de las crucetas. Colocación de las baldosas con llana dentada y doble encolado. Relleno, si procede, de las juntas de partición intermedias. Rejuntado. Eliminación y limpieza del material sobrante. Limpieza inicial del pavimento al finalizar la obra y protección hasta entrega de obra. Todo el proceso de colocación se efectuará según indicaciones de la dirección facultativa y norma UNE 138002.`;
    const revestimientoTemplate = `Suministro y ejecución de revestimiento con <span class="resaltado">{tipo_material}</span>, de aspecto <span class="resaltado">{aspecto}</span>, colección <span class="resaltado">{coleccion}</span>, color <span class="resaltado">{color}</span> de <span class="resaltado">{fabricante}</span>.\n\nCerámica con dimensiones nominales (Ancho x Largo x Espesor) <span class="resaltado">{dim_ancho}</span>x<span class="resaltado">{dim_alto}</span>x<span class="resaltado">{dim_espesor}</span> cm, desviación de longitud/anchura, rectitud de lados, ortogonalidad y planimetría inferior a <span class="resaltado">{desviacion}</span> (<span class="resaltado">{norma_dimensiones}</span>).\n\nDestonificado <span class="resaltado">{destonificado}</span> con una absorción de agua <span class="resaltado">{absorcion_agua}</span>, módulo de rotura <span class="resaltado">{modulo_rotura}</span> y fuerza de rotura <span class="resaltado">{carga_rotura}</span> (ISO-13006:2018 UNE-EN 14411:2016).\n\nContribuye a los estándares de construcción sostenible y saludable (LEED, BREEAM, WELL) gracias a disponer de Declaración Ambiental de Producto propia (DAP), no ser una fuente emisora de sustancias peligrosas COVs ni formaldehidos, así como por disponer de contenido de material reciclado >6%.\n\nColocación en capa fina, con adhesivo cementoso tecnológico avanzado, <span class="resaltado">{adhesivo_nombre}</span> de <span class="resaltado">{adhesivo_fabricante}</span>, tipo <span class="resaltado">{adhesivo_tipo}</span> según EN 12004, prescrito de acuerdo a las indicaciones de la UNE 138002 y rejuntadas con mortero de juntas cementoso de fraguado y endurecimiento rápido, <span class="resaltado">{mortero_nombre}</span> de <span class="resaltado">{mortero_fabricante}</span>, según EN 13888, para juntas de hasta <span class="resaltado">{junta_maxima}</span> mm.\n\nI/p.p medios auxiliares. Utilización de p/p de Crucetas Autonivelantes (no incluidas), formación de juntas perimetrales continuas, de anchura no menor de <span class="resaltado">{junta_perimetral}</span> mm, en los límites con paredes, pilares exentos y elevaciones de nivel y, en su caso, juntas de partición intermedias. Respetar juntas estructurales existentes en el soporte. Limpieza y comprobación del grado de humedad de la base. Replanteo de niveles. Replanteo de la disposición de las baldosas y juntas de movimiento. Aplicación del adhesivo. Colocación de las crucetas. Colocación de las baldosas con llana dentada y doble encolado. Relleno, si procede, de las juntas de partición intermedias. Rejuntado. Eliminación y limpieza del material sobrante. Limpieza inicial del pavimento al finalizar la obra y protección hasta entrega de obra. Todo el proceso de colocación se efectuará según indicaciones de la dirección facultativa y norma UNE 138002.`;

    // --- LÓGICA DE VISTAS Y ESTADO ---
    function displayEmptyState() {
        selectedProductIndex = null;
        ui.productResultsList.innerHTML = '';
        ui.imageContainer.classList.add('oculto');
        ui.output.classList.add('oculto');
        ui.camposEditablesContainer.classList.add('oculto');
        ui.emptyState.classList.remove('oculto');
        ui.formulario.reset();
    }
    
    function displayProductView() {
        ui.emptyState.classList.add('oculto');
        ui.imageContainer.classList.remove('oculto');
        ui.output.classList.remove('oculto');
        ui.camposEditablesContainer.classList.remove('oculto');
    }

    // --- LÓGICA DE DATOS Y RENDERIZADO ---
    function displayProductDetails(product) {
        if (!product) {
            displayEmptyState();
            return;
        }
        displayProductView();

        // Rellena los campos ocultos del formulario con los datos del producto
        const productType = product['Desc_Familia_web'] || '';
        document.getElementById('tipo_material').value = productType;
        document.getElementById('coleccion').value = product['MODELO'] || '';
        document.getElementById('color').value = product['COLOR'] || '';
        document.getElementById('aspecto').value = [product['Efecto'], product['Acabado']].filter(Boolean).join(' / ');
        document.getElementById('dim_ancho').value = product['Ancho'] ? product['Ancho'].replace(',', '.') : '';
        document.getElementById('dim_alto').value = product['Alto'] ? product['Alto'].replace(',', '.') : '';
        document.getElementById('dim_espesor').value = product['Espesor(mm)'] ? product['Espesor(mm)'].replace(',', '.') : '';
        document.getElementById('destonificado').value = product['Variacion_cromatica'] || '';
        document.getElementById('absorcion_agua').value = product['iso_10545_3_absorcion_agua'] || '';
        document.getElementById('clase_resbaladicidad').value = product['en_16165_anexo_c_deslizamiento_pendulo'] || '';
        document.getElementById('valor_rd').value = product['(Rd)'] || '';
        document.getElementById('resistencia_manchas').value = product['Resistenci_ a_manchas'] || '';
        document.getElementById('resistencia_quimica').value = product['Resistencia_a_ataques_químicos'] || '';
        document.getElementById('modulo_rotura').value = product['iso_10545_4_resistencia_flexion'] || '';
        document.getElementById('carga_rotura').value = product['iso_10545_4_fuerza_rotura'] || '';
        
        // Lógica de valores editables
        document.getElementById('adhesivo_tipo').value = product['Adhesivo'] || 'C2';
        document.getElementById('junta_maxima').value = revestimientoTypes.includes(productType) ? "4" : "15";
        
        // Actualiza los links
        ui.linkDAP.href = product['declaracion_ambiental_producto'] || '#';
        ui.linkDOP.href = product['declaracion_prestaciones'] || '#';

        // Actualiza la imagen
        previewProductImage(product);
        
        generarTexto();
    }

    function generarTexto() {
        if (selectedProductIndex === null) return;
        const values = {};
        for (let el of ui.formulario.elements) { if (el.id) values[el.id] = el.value; }
        
        const selectedProductType = values['tipo_material'];
        let activeTemplate = revestimientoTypes.includes(selectedProductType) ? revestimientoTemplate : pavimentoTemplate;
        
        let textoHTML = activeTemplate;
        for (const key in values) {
            textoHTML = textoHTML.replace(new RegExp(`{${key}}`, 'g'), values[key] || '[DATO NO ESPECIFICADO]');
        }
        ui.output.innerHTML = textoHTML;
    }

    function previewProductImage(product) {
        ui.imageContainer.classList.remove('oculto');
        const imageUrl = product['imagen_url_web'];
        if (imageUrl && imageUrl.trim() !== "") {
            ui.imagePlaceholder.classList.add('oculto');
            ui.imagenProducto.classList.remove('oculto');
            ui.imagenProducto.src = imageUrl; 
            ui.btnDescargarImagen.classList.remove('oculto');
        } else {
            ui.imagePlaceholder.classList.remove('oculto');
            ui.imagenProducto.classList.add('oculto');
            ui.btnDescargarImagen.classList.add('oculto');
        }
    }

    // --- LÓGICA DE FILTROS ---
    function updateFiltersAndProductList() {
        // 1. Filtrar por checkboxes rápidos
        let filteredProducts = csvData.filter(product => {
            const is20mm = !document.getElementById('filtro-20mm').checked || (product['Espesor(mm)'] && product['Espesor(mm)'].startsWith('2'));
            const isExt = !document.getElementById('filtro-ext').checked || (product['Acabado'] && product['Acabado'].toUpperCase() === 'EXT');
            const isDup = !document.getElementById('filtro-dup').checked || (product['MODELO'] && product['MODELO'].toUpperCase().includes('DUP'));
            return is20mm && isExt && isDup;
        });
        
        // 2. Obtener los valores seleccionados en los <select>
        const activeSelectFilters = {};
        Object.keys(ui.allSelectFilters).forEach(key => {
            if (ui.allSelectFilters[key].value) {
                activeSelectFilters[key] = ui.allSelectFilters[key].value;
            }
        });

        // 3. Filtrar por los <select> activos
        if (Object.keys(activeSelectFilters).length > 0) {
            filteredProducts = filteredProducts.filter(product => {
                return Object.keys(activeSelectFilters).every(key => product[key] === activeSelectFilters[key]);
            });
        }
        
        // 4. Actualizar las opciones de los <select> con contadores
        Object.keys(ui.allSelectFilters).forEach(currentKey => {
            const otherFilters = { ...activeSelectFilters };
            delete otherFilters[currentKey];
            
            // Para obtener las opciones de un filtro, partimos de los productos filtrados por los checkboxes y los *otros* selects.
            const availableProductsForThisSelect = csvData.filter(product => {
                const quickFiltersPass = (!document.getElementById('filtro-20mm').checked || (product['Espesor(mm)'] && product['Espesor(mm)'].startsWith('2'))) &&
                                         (!document.getElementById('filtro-ext').checked || (product['Acabado'] && product['Acabado'].toUpperCase() === 'EXT')) &&
                                         (!document.getElementById('filtro-dup').checked || (product['MODELO'] && product['MODELO'].toUpperCase().includes('DUP')));
                const otherSelectsPass = Object.keys(otherFilters).every(key => product[key] === otherFilters[key]);
                return quickFiltersPass && otherSelectsPass;
            });
            
            repopulateSelectWithOptions(ui.allSelectFilters[currentKey], availableProductsForThisSelect);
        });

        // 5. Renderizar la lista de resultados y actualizar mensaje de estado
        renderProductList(filteredProducts);
        ui.statusMessage.textContent = `${filteredProducts.length} productos encontrados.`;
    }
    
    function repopulateSelectWithOptions(selectElement, availableProducts) {
        const currentValue = selectElement.value;
        const csvCol = selectElement.dataset.csvCol;

        // Contar ocurrencias de cada opción
        const counts = availableProducts.reduce((acc, product) => {
            const value = product[csvCol];
            if (value) {
                acc[value] = (acc[value] || 0) + 1;
            }
            return acc;
        }, {});
        
        const sortedOptions = Object.keys(counts).sort();

        selectElement.innerHTML = `<option value="">Todos (${availableProducts.length})</option>`;
        sortedOptions.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = `${value} (${counts[value]})`;
            if (value === currentValue) option.selected = true;
            selectElement.appendChild(option);
        });
    }

    function renderProductList(products) {
        ui.productResultsList.innerHTML = '';
        if (products.length === 0) {
            ui.productResultsList.innerHTML = '<p style="text-align:center; padding: 20px; color: var(--color-texto-secundario);">No se encontraron productos con estos filtros.</p>';
            return;
        }

        products.forEach(product => {
            const originalIndex = csvData.findIndex(p => p === product);
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.index = originalIndex;

            if (originalIndex === selectedProductIndex) {
                card.classList.add('selected');
            }

            const title = document.createElement('h5');
            title.className = 'card-title';
            title.textContent = `${product.MODELO || 'S/M'} - ${product.COLOR || 'S/C'}`;

            const diffs = document.createElement('p');
            diffs.className = 'card-differentiators';
            diffs.textContent = `Formato: ${product.FORMATO || 'N/A'} | Acabado: ${product.Acabado || 'N/A'}`;

            const specs = document.createElement('div');
            specs.className = 'card-specs';
            const spec1 = product['Desc_Familia_web'] ? `<span class="spec-tag">${product['Desc_Familia_web']}</span>` : '';
            const spec2 = product['en_16165_anexo_c_deslizamiento_pendulo'] ? `<span class="spec-tag">CLASE ${product['en_16165_anexo_c_deslizamiento_pendulo']}</span>` : '';
            const spec3 = product['Espesor(mm)'] ? `<span class="spec-tag">${product['Espesor(mm)']}mm</span>` : '';
            specs.innerHTML = spec1 + spec2 + spec3;

            card.appendChild(title);
            card.appendChild(diffs);
            card.appendChild(specs);

            card.addEventListener('mouseover', handleCardMouseOver);
            card.addEventListener('click', handleCardClick);

            ui.productResultsList.appendChild(card);
        });
    }
    
    function clearFilters() {
         ui.quickFilters.forEach(qf => qf.checked = false);
         Object.values(ui.allSelectFilters).forEach(select => select.value = '');
         if(ui.advancedFiltersToggle.classList.contains('open')) toggleAdvancedFilters();
         displayEmptyState();
         updateFiltersAndProductList();
    }
    
    function toggleAdvancedFilters() {
        ui.advancedFiltersToggle.classList.toggle('open');
        ui.advancedFiltersContent.style.display = ui.advancedFiltersContent.style.display === 'block' ? 'none' : 'block';
    }

    // --- CARGA INICIAL DE DATOS ---
    async function loadDataAndInitializeApp() {
        const csvFilePath = 'BD_contrac_presto3.csv'; 
        
        ui.statusMessage.textContent = 'Cargando datos de productos...';

        try {
            const response = await fetch(csvFilePath);
            if (!response.ok) throw new Error(`No se pudo cargar el archivo: ${response.statusText}`);
            
            const csvText = await response.text();
            csvData = parseCSV(csvText);
            
            if (csvData.length === 0) throw new Error("No se encontraron datos válidos en el archivo CSV.");
            
            Object.values(ui.allSelectFilters).forEach(select => { select.disabled = false; });
            updateFiltersAndProductList();
        
        } catch (error) {
            ui.statusMessage.textContent = `Error crítico: No se pudieron cargar los datos.`;
            console.error("Error al cargar y procesar el CSV:", error);
        }
    }

    function parseCSV(text) {
        const lines = text.trim().split(/\r\n|\n/);
        if (lines.length < 2) throw new Error("CSV inválido.");
        const headerLine = lines[0].replace(/^\uFEFF/, '');
        const delimiter = (headerLine.match(/;/g) || []).length > (headerLine.match(/,/g) || []).length ? ';' : ',';
        const headers = headerLine.split(delimiter).map(h => h.trim());
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line === '') continue;
            const values = line.split(delimiter);
            if (values.length < headers.length) continue; 
            const entry = {};
            headers.forEach((header, index) => {
                if (header) entry[header] = values[index] ? values[index].trim() : '';
            });
            data.push(entry);
        }
        return data;
    }

    // --- FUNCIONALIDAD PDF ---
    async function generarPDF() {
        if (selectedProductIndex === null) {
            alert("Por favor, selecciona un producto para generar el PDF.");
            return;
        }

        const originalButtonText = ui.btnDescargarPdf.textContent;
        ui.btnDescargarPdf.textContent = 'Generando...';
        ui.btnDescargarPdf.disabled = true;

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const MARGIN_LEFT = 20, MARGIN_TOP = 20, MARGIN_RIGHT = 20;
            const PAGE_HEIGHT = 297, PAGE_WIDTH = 210;
            const CONTENT_WIDTH = PAGE_WIDTH - MARGIN_LEFT - MARGIN_RIGHT;
            let currentY = MARGIN_TOP;

            const imageToBase64 = async (url) => {
                try {
                    if (!url || url.trim() === '') return null;
                    const response = await fetch(url);
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (e) {
                    console.error(`No se pudo cargar la imagen: ${url}`, e);
                    return null;
                }
            };
            
            const logoBase64 = await imageToBase64('LOGO-PAMESA.jpg');
            const productoBase64 = await imageToBase64(ui.imagenProducto.src);
            const product = csvData[selectedProductIndex];

            // ENCABEZADO
            if (logoBase64) doc.addImage(logoBase64, 'JPEG', MARGIN_LEFT, 12, 50, 10);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.setTextColor('#222222');
            doc.text('Prescripción Técnica de Obra', PAGE_WIDTH - MARGIN_RIGHT, 18, { align: 'right' });
            currentY += 15;
            doc.setDrawColor('#ce1719');
            doc.setLineWidth(0.5);
            doc.line(MARGIN_LEFT, currentY, PAGE_WIDTH - MARGIN_RIGHT, currentY);
            currentY += 15;

            // TÍTULO
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.setTextColor('#ce1719');
            const title = `${product.MODELO || 'Modelo'} - ${product.COLOR || 'Color'} - ${product.FORMATO || 'Formato'}`;
            doc.text(title, MARGIN_LEFT, currentY);
            currentY += 10;

            // IMAGEN Y TEXTO
            let textX = MARGIN_LEFT;
            let textWidth = CONTENT_WIDTH;
            const imgWidth = 70, imgHeight = 70, gap = 10;
            const imgBottomY = currentY + imgHeight + 10;
            if (productoBase64) {
                doc.addImage(productoBase64, 'JPEG', MARGIN_LEFT, currentY, imgWidth, imgHeight);
                textX = MARGIN_LEFT + imgWidth + gap;
                textWidth = CONTENT_WIDTH - imgWidth - gap;
            }
            
            const textoPrescripcion = document.getElementById('texto-generado').innerHTML;
            let textoProcesado = textoPrescripcion.replace(/<br\s*\/?>/gi, '\n').replace(/<span class="resaltado">/g, '##START##').replace(/<\/span>/g, '##END##').replace(/&nbsp;/g, ' ');
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor('#333333');
            const paragraphs = textoProcesado.split('\n');
            const lineHeight = 5; 
            
            const printLineBuffer = (doc, buffer, x, y) => {
                let currentX = x;
                buffer.forEach(item => {
                    doc.setFont('helvetica', item.bold ? 'bold' : 'normal');
                    doc.setTextColor(item.bold ? '#ce1719' : '#333333');
                    doc.text(item.text, currentX, y);
                    currentX += doc.getStringUnitWidth(item.text) * doc.getFontSize() / doc.internal.scaleFactor;
                });
            };

            const checkPageBreak = () => {
                if (productoBase64 && currentY > imgBottomY && textWidth < CONTENT_WIDTH) {
                    textX = MARGIN_LEFT;
                    textWidth = CONTENT_WIDTH;
                }
                if (currentY > PAGE_HEIGHT - 25) {
                    doc.addPage();
                    currentY = MARGIN_TOP;
                    textX = MARGIN_LEFT;
                    textWidth = CONTENT_WIDTH;
                }
            };

            paragraphs.forEach(paragraph => {
                if (paragraph.trim() === '') {
                    currentY += lineHeight;
                    return;
                }
                const parts = paragraph.split(/(##START##|##END##)/g);
                let isBold = false;
                let tokens = [];
                parts.forEach(part => {
                    if (part === '##START##') isBold = true;
                    else if (part === '##END##') isBold = false;
                    else if (part !== '') tokens.push({ text: part, bold: isBold });
                });
                let lineBuffer = [];
                let currentLineWidth = 0;
                tokens.forEach(token => {
                    const words = token.text.split(' ');
                    words.forEach((word, index) => {
                        let wordText = word + (index < words.length - 1 || token.text.endsWith(' ') ? ' ' : '');
                        if (index === 0 && lineBuffer.length > 0 && !lineBuffer[lineBuffer.length - 1].text.endsWith(' ')) wordText = ' ' + wordText;
                        doc.setFont('helvetica', token.bold ? 'bold' : 'normal');
                        const wordWidth = doc.getStringUnitWidth(wordText) * doc.getFontSize() / doc.internal.scaleFactor;
                        if (currentLineWidth + wordWidth > textWidth) {
                            printLineBuffer(doc, lineBuffer, textX, currentY);
                            currentY += lineHeight;
                            checkPageBreak();
                            lineBuffer = [{ text: wordText.trimStart(), bold: token.bold, width: wordWidth }];
                            currentLineWidth = wordWidth;
                        } else {
                            lineBuffer.push({ text: wordText, bold: token.bold, width: wordWidth });
                            currentLineWidth += wordWidth;
                        }
                    });
                });
                if (lineBuffer.length > 0) {
                    printLineBuffer(doc, lineBuffer, textX, currentY);
                    currentY += lineHeight * 1.5;
                    checkPageBreak();
                }
            });

            // PIE DE PÁGINA
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor('#888888');
                const footerText = `Pamesa Cerámica | Documento generado el ${new Date().toLocaleDateString()} | Página ${i} de ${pageCount}`;
                doc.text(footerText, PAGE_WIDTH / 2, PAGE_HEIGHT - 10, { align: 'center' });
            }

            const fileName = `prescripcion_Pamesa_${product.MODELO || 'modelo'}_${product.COLOR || 'color'}.pdf`;
            doc.save(fileName.replace(/[/\\?%*:|"<>]/g, '-'));
        } catch (error) {
            console.error("Error al generar el PDF:", error);
            alert("Ocurrió un error al generar el PDF. Revisa la consola para más detalles.");
        } finally {
            ui.btnDescargarPdf.textContent = originalButtonText;
            ui.btnDescargarPdf.disabled = false;
        }
    }

    // --- MANEJADORES DE EVENTOS ---
    function handleCardMouseOver(event) {
        const index = parseInt(event.currentTarget.dataset.index, 10);
        if (csvData[index]) {
            previewProductImage(csvData[index]);
        }
    }

    function handleCardClick(event) {
        const card = event.currentTarget;
        const index = parseInt(card.dataset.index, 10);
        
        if (selectedProductIndex === index) {
            // Deseleccionar si se hace clic en el mismo
            selectedProductIndex = null;
            card.classList.remove('selected');
            displayEmptyState();
            updateFiltersAndProductList(); // Re-render para quitar la selección
        } else {
            selectedProductIndex = index;
            // Actualizar vista
            const currentlySelected = document.querySelector('.product-card.selected');
            if (currentlySelected) currentlySelected.classList.remove('selected');
            card.classList.add('selected');
            // Mostrar detalles
            if (csvData[index]) {
                displayProductDetails(csvData[index]);
            }
        }
    }

    ui.imagenProducto.addEventListener('error', () => {
        ui.imagenProducto.classList.add('oculto');
        ui.imagePlaceholder.classList.remove('oculto');
        ui.btnDescargarImagen.classList.add('oculto');
    });

    Array.from(ui.formulario.elements).forEach(el => el.addEventListener('input', generarTexto));
    ui.btnClearFilters.addEventListener('click', clearFilters);
    ui.advancedFiltersToggle.addEventListener('click', toggleAdvancedFilters);
    Object.values(ui.allSelectFilters).forEach(select => select.addEventListener('change', updateFiltersAndProductList));
    ui.quickFilters.forEach(qf => qf.addEventListener('change', updateFiltersAndProductList));
    
    ui.btnCopiar.addEventListener('click', () => {
        if (selectedProductIndex === null || ui.output.classList.contains('oculto')) return;
        navigator.clipboard.writeText(ui.output.textContent).then(() => {
            const original = ui.btnCopiar.textContent;
            ui.btnCopiar.textContent = '¡Copiado!';
            setTimeout(() => { ui.btnCopiar.textContent = original; }, 2000);
        });
    });

    ui.btnDescargarTxt.addEventListener('click', () => {
        if (selectedProductIndex === null || ui.output.classList.contains('oculto')) return;
        const blob = new Blob([ui.output.textContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const product = csvData[selectedProductIndex];
        const fileName = `prescripcion_Pamesa_${product.MODELO || 'modelo'}_${product.COLOR || 'color'}.txt`;
        a.href = url;
        a.download = fileName.replace(/[/\\?%*:|"<>]/g, '-');
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
    
    ui.btnDescargarPdf.addEventListener('click', generarPDF);

    ui.btnDescargarImagen.addEventListener('click', async () => {
        const imageUrl = ui.imagenProducto.src;
        if (selectedProductIndex === null || !imageUrl || ui.imagenProducto.classList.contains('oculto')) return;
        try {
            const response = await fetch(imageUrl);
            if (!response.ok) throw new Error('Network response was not ok');
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const product = csvData[selectedProductIndex];
            const fileName = `Pamesa_${product.MODELO || 'modelo'}_${product.COLOR || 'color'}.jpg`;
            a.href = url;
            a.download = fileName.replace(/[/\\?%*:|"<>]/g, '-');
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error("Error al descargar la imagen:", error);
            window.open(imageUrl, '_blank');
        }
    });

    // Inicialización
    displayEmptyState();
    loadDataAndInitializeApp(); 
});
    </script>
</body>
</html>