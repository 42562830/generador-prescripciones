<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Prescripciones de Obra v3.7 - Pamesa Cerámica</title>
    
    <!-- LIBRERÍAS EXTERNAS -->
    <!-- Fuente Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Librería jsPDF para generar el PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --color-principal: #ce1719;
            --color-principal-hover: #b51517;
            --color-secundario: #4a4a4a;
            --color-secundario-hover: #333333;
            --color-blanco: #ffffff;
            --color-texto-principal: #222;
            --color-texto-secundario: #555;
            --color-titulos: #000;
            --color-fondo: #f9fafb;
            --color-fondo-suave: #f8f8f8;
            --color-borde-suave: #e5e5e5;
            --font-main: 'Montserrat', sans-serif;
            --radio-borde: 8px;
            --sombra-suave: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --max-width-container: 1800px;
            --spacing-unit: 8px; /* INICIO MEJORA: Unidad de espaciado base */
        }

        /* --- ESTILOS BASE Y RESET --- */
        * { box-sizing: border-box; }
        html { height: 100%; }
        body {
            font-family: var(--font-main);
            background-color: var(--color-fondo);
            color: var(--color-texto-principal);
            margin: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* --- INICIO MEJORA: PANTALLA DE LOGIN PREMIUM --- */
        @keyframes zoomInBackground {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        @keyframes fadeInFromBottom {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        #login-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.3); /* Fondo oscurecido más sutil */
            backdrop-filter: blur(8px); /* Efecto cristal esmerilado */
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
            overflow: hidden;
        }
        
        #login-overlay::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('image-index.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            z-index: -1;
            animation: zoomInBackground 20s ease-in-out infinite alternate;
        }

        #login-box {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 40px 50px;
            border-radius: var(--radio-borde);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); /* Sombra más difusa y premium */
            text-align: center;
            width: 100%;
            max-width: 420px;
            border-top: 4px solid var(--color-principal);
            animation: fadeInFromBottom 0.5s ease-out; /* Animación de entrada */
        }
        #login-logo { max-width: 200px; margin-bottom: 24px; }
        #login-box h2 { font-size: 1.5em; color: var(--color-titulos); font-weight: 600; margin: 0 0 8px 0; }
        #login-box p { color: var(--color-texto-secundario); margin-bottom: 32px; }
        #login-box .campo { text-align: left; }
        #login-box .campo input { padding: 12px 16px; font-size: 1em; }
        #login-button { width: 100%; padding: 12px; font-size: 1em; margin-top: 8px; }
        #login-error { color: var(--color-principal); font-weight: 600; font-size: 0.9em; height: 20px; margin-top: 16px; }
        /* --- FIN MEJORA --- */

        /* --- CABECERA --- */
        .header-corporativo {
            background-color: var(--color-blanco);
            padding: 16px 32px;
            border-bottom: 1px solid var(--color-borde-suave);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            z-index: 10;
            flex-shrink: 0;
        }
        .header-container { max-width: var(--max-width-container); margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .header-corporativo img { height: 35px; width: auto; }
        .header-corporativo h1 { font-size: 1.4em; color: var(--color-titulos); font-weight: 600; margin: 0; text-align: right; }
        #logout-link { color: var(--color-principal); text-decoration: none; font-weight: 600; }
        #logout-link:hover { text-decoration: underline; }
        
        /* --- INICIO MEJORA: ESTRUCTURA DE VISTAS CON TRANSICIONES --- */
        .main-content { 
            padding: 24px; 
            flex-grow: 1;
            overflow: hidden;
            position: relative; /* Contenedor para las vistas posicionadas */
        }
        .view-section {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            height: 100%;
            width: 100%;
            max-width: var(--max-width-container);
            margin: 0 auto;
            gap: 24px;
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none; /* Evita interacciones cuando está oculta */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .view-section.active-view {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
            position: relative; /* Ocupa espacio en el layout cuando está activa */
        }
        /* --- FIN MEJORA --- */

        /* --- COLUMNAS Y PANELES --- */
        .col-left { flex: 1; min-width: 350px; max-width: 450px; display: flex; flex-direction: column; }
        .col-right { flex: 2; display: flex; flex-direction: column; min-width: 0; }
        .panel {
            background-color: var(--color-blanco);
            border-radius: var(--radio-borde);
            box-shadow: var(--sombra-suave);
            border: 1px solid var(--color-borde-suave);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }
        .panel-header {
            padding: 24px;
            border-bottom: 1px solid var(--color-borde-suave);
            background-color: #fff;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-body { padding: 24px; overflow-y: auto; flex-grow: 1; }
        .panel-body::-webkit-scrollbar, #product-results-list::-webkit-scrollbar { width: 8px; }
        .panel-body::-webkit-scrollbar-track, #product-results-list::-webkit-scrollbar-track { background: var(--color-fondo-suave); }
        .panel-body::-webkit-scrollbar-thumb, #product-results-list::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 20px; border: 2px solid var(--color-fondo-suave); }
        .panel-body::-webkit-scrollbar-thumb:hover { background-color: #bbb; }
        
        /* --- HISTORIAL (ESTILOS MEJORADOS) --- */
        #history-list .history-item {
            padding: 12px;
            border-bottom: 1px solid var(--color-borde-suave);
            font-size: 0.9em;
        }
        #history-list .history-item:last-child { border-bottom: none; }
        #history-list .history-item strong { display: block; color: var(--color-texto-principal); }
        #history-list .history-item .details { font-size: 0.9em; color: #666; padding: 4px 0; }
        #history-list .history-item small { display: block; color: #888; font-size: 0.85em; }

        /* --- MODO 1: BUSCADOR --- */
        #formulario-busqueda { padding: 8px; }
        #product-results-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
            padding: 24px;
            overflow-y: auto;
            height: 100%;
            background-color: var(--color-fondo-suave);
            transition: opacity 0.2s ease-in-out; /* INICIO MEJORA: Transición para feedback de carga */
        }
        #product-results-list.is-loading { opacity: 0.5; } /* FIN MEJORA */

        .product-card {
            background: white; border: 1px solid var(--color-borde-suave); border-radius: var(--radio-borde); padding: 16px; cursor: pointer;
            transition: all 0.2s ease; display: flex; gap: 16px; align-items: center;
        }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: var(--color-principal); }
        .card-thumb-container {
            width: 80px; height: 80px; border-radius: 6px; background-color: #eee; flex-shrink: 0; overflow: hidden;
            display: flex; align-items: center; justify-content: center; position: relative; cursor: zoom-in;
        }
        
        /* --- INICIO MEJORA: Icono de Lupa SVG unificado --- */
        .card-thumb-container::after, #detail-image-container::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3E%3Cpath fill-rule='evenodd' d='M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: center; background-size: 32px 32px;
            opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none;
        }
        .card-thumb-container:hover::after, #detail-image-container:hover::after { opacity: 1; }
        /* --- FIN MEJORA --- */

        .card-thumb { width: 100%; height: 100%; object-fit: cover; }
        .card-no-thumb { font-size: 0.7em; color: #999; text-align: center; padding: 5px; }
        .card-info { flex-grow: 1; min-width: 0; }
        .card-title { font-weight: 700; font-size: 1em; color: var(--color-texto-principal); margin: 0 0 4px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-sub { font-size: 0.85em; color: var(--color-texto-secundario); margin-bottom: 8px; }
        .card-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag { background: #f0f0f0; color: #555; font-size: 0.7em; padding: 3px 8px; border-radius: 4px; font-weight: 600; }

        /* --- MODO 2: DETALLE --- */
        .btn-volver {
            background: none; border: none; color: var(--color-texto-secundario); font-weight: 600; font-size: 0.95em;
            cursor: pointer; display: flex; align-items: center; gap: 8px; transition: color 0.2s;
        }
        .btn-volver:hover { color: var(--color-principal); }
        .btn-volver svg { width: 20px; height: 20px; }
        #detail-image-container {
            width: 100%; max-height: 40vh; background-color: #fff; border: 1px solid var(--color-borde-suave); border-radius: var(--radio-borde);
            display: flex; align-items: center; justify-content: center; margin-bottom: 24px; overflow: hidden;
            position: relative; cursor: zoom-in;
        }
        #detail-product-image { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        /* --- INICIO MEJORA: SE PERMITE SELECCIÓN DE TEXTO --- */
        #texto-generado {
            font-family: var(--font-main); font-size: 1.05em; line-height: 1.9; color: #333;
            white-space: pre-wrap; margin: 0;
            /* user-select: none; HA SIDO ELIMINADO PARA PERMITIR COPIA PARCIAL */
        }
        /* --- FIN MEJORA --- */
        .resaltado { color: var(--color-principal); font-weight: 600; }

        /* --- COMPONENTES COMUNES --- */
        fieldset { border: 1px solid var(--color-borde-suave); border-radius: var(--radio-borde); padding: 16px; margin: 0 0 24px 0; }
        legend { font-weight: 600; font-size: 1em; color: var(--color-principal); padding: 0 8px; }
        .campo { margin-bottom: 16px; }
        .campo label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.85em; color: var(--color-secundario); }
        .campo input, .campo select {
            width: 100%; padding: 10px 12px; border: 1px solid var(--color-borde-suave);
            border-radius: 6px; font-family: var(--font-main); font-size: 0.95em;
        }
        .campo input:focus, .campo select:focus { outline: none; border-color: var(--color-principal); box-shadow: 0 0 0 2px rgba(206, 23, 25, 0.2); }
        .acciones-container { display: flex; flex-wrap: wrap; gap: 12px; }
        .btn-accion {
            background-color: var(--color-principal); color: white; border: none; padding: 10px 18px; border-radius: 6px;
            cursor: pointer; font-weight: 600; font-size: 0.9em; text-decoration: none;
            display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .btn-accion:hover { background-color: var(--color-principal-hover); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-accion.secundario { background-color: var(--color-secundario); }
        .btn-accion.secundario:hover { background-color: var(--color-secundario-hover); }
        .filtros-rapidos { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
        .filtro-toggle-label {
            padding: 6px 12px; border: 1px solid var(--color-borde-suave); border-radius: 20px;
            font-size: 0.8em; cursor: pointer; background: #f8f8f8; transition: all 0.2s;
        }
        .filtro-toggle-input:checked + .filtro-toggle-label { background-color: var(--color-principal); color: white; border-color: var(--color-principal); }
        #status-message { text-align: center; font-weight: 600; margin-top: 16px; font-size: 0.9em; color: #666; }
        .btn-limpiar {
            background: none; border: 1px solid var(--color-borde-suave); color: var(--color-secundario);
            border-radius: 6px; padding: 6px 12px; font-size: 0.8em; cursor: pointer; font-weight: 600;
            transition: all 0.2s ease;
        }
        /* --- INICIO MEJORA: Botón de limpiar más visible cuando hay filtros activos --- */
        .btn-limpiar.active {
            border-color: var(--color-principal);
            background-color: var(--color-principal);
            color: var(--color-blanco);
        }
        /* --- FIN MEJORA --- */
        .empty-search-state {
            grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #999; text-align: center;
        }
        .empty-search-state svg { width: 60px; height: 60px; margin-bottom: 16px; opacity: 0.3; }
        .oculto { display: none !important; }

        /* --- INICIO MEJORA: Estilos para Skeleton Loaders --- */
        @keyframes shimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
        .skeleton-card { display: flex; gap: 16px; align-items: center; padding: 16px; background: #fff; border-radius: var(--radio-borde); }
        .skeleton-thumb { width: 80px; height: 80px; border-radius: 6px; background: #f0f0f0; }
        .skeleton-info { flex-grow: 1; }
        .skeleton-line { height: 1em; border-radius: 4px; background: #f0f0f0; }
        .skeleton-line.title { width: 70%; margin-bottom: 8px; height: 1.2em; }
        .skeleton-line.sub { width: 50%; }
        .skeleton-thumb, .skeleton-line {
            background-image: linear-gradient(to right, #f0f0f0 0%, #e0e0e0 20%, #f0f0f0 40%, #f0f0f0 100%);
            background-repeat: no-repeat; background-size: 800px 104px;
            animation: shimmer 1.5s linear infinite;
        }
        /* --- FIN MEJORA --- */

        /* --- INICIO MEJORA: Estilos para el Modal de Imagen (Lightbox) --- */
        #image-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85);
            z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;
            cursor: zoom-out; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out;
        }
        #image-modal-overlay.visible { opacity: 1; pointer-events: auto; }
        #modal-content { position: relative; max-width: 95%; max-height: 95%; display: flex; align-items: center; justify-content: center; }
        #modal-image { max-width: 100%; max-height: 100%; width: auto; height: auto; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #modal-close-btn {
            position: absolute; top: -40px; right: -20px; background: none; border: none; color: white;
            font-size: 40px; line-height: 1; font-weight: 300; cursor: pointer; padding: 5px; opacity: 0.8; transition: opacity 0.2s;
        }
        #modal-close-btn:hover { opacity: 1; }
        @media (max-width: 768px) {
            #modal-close-btn {
                top: -35px; right: 0px; font-size: 35px; background-color: rgba(0,0,0,0.3); border-radius: 50%;
                width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;
            }
        }
        /* --- FIN MEJORA --- */

        /* Responsive */
        @media (max-width: 900px) {
            .main-content { padding: 16px; }
            .view-section {
                flex-direction: column;
                overflow-y: auto;
                position: relative; /* En móvil, no se superponen */
                display: none;
            }
            .view-section.active-view { display: block; }
            .col-left, .col-right { width: 100%; max-width: none; flex: none; }
            .panel { height: auto; margin-bottom: 24px; overflow: visible; }
            #product-results-list { height: 400px; overflow-y: auto; padding: 16px; }
        }
    </style>
</head>
<body>

    <!-- ================================================== -->
    <!-- PANTALLA DE LOGIN (SOBREPUESTA) -->
    <!-- ================================================== -->
    <div id="login-overlay">
        <div id="login-box">
            <img src="LOGO-PAMESA.jpg" alt="Logo Pamesa Cerámica" id="login-logo">
            <h2>Acceso al Generador</h2>
            <p>Introduce tus credenciales para continuar.</p>
            <div class="campo">
                <label for="login-username">Nombre de Usuario</label>
                <input type="text" id="login-username" placeholder="Tu nombre o identificador">
            </div>
            <div class="campo">
                <label for="login-password">Contraseña</label>
                <input type="password" id="login-password" placeholder="••••••••••">
            </div>
            <div id="login-error"></div>
            <button id="login-button" class="btn-accion">Entrar</button>
        </div>
    </div>


    <header class="header-corporativo">
        <div class="header-container">
            <img src="LOGO-PAMESA.jpg" alt="Logo Pamesa Cerámica" onerror="this.style.display='none'">
            <div style="text-align: right;">
                <h1 style="margin-bottom: 5px;">Generador de Prescripciones v3.7</h1>
                <div id="user-info" class="oculto" style="font-size: 0.9em;">
                    <span id="user-greeting"></span> | <a href="#" id="logout-link">Salir</a>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        
        <!-- ========================================= -->
        <!-- MODO 1: BÚSQUEDA (Vista por defecto)      -->
        <!-- ========================================= -->
        <div id="view-search" class="view-section">
            
            <div class="col-left">
                <!-- Panel de Filtros -->
                <div class="panel">
                    <div class="panel-header">
                        <h3 style="margin:0; font-size:1.1em;">Filtros de Búsqueda</h3>
                        <button type="button" id="btn-clear-filters" class="btn-limpiar">Limpiar</button>
                    </div>
                    <div class="panel-body">
                        <div id="formulario-busqueda">
                            <div class="campo"><label for="search-keyword">Búsqueda por palabra</label><input type="text" id="search-keyword" placeholder="Buscar en Serie, Modelo, Efecto..."></div>
                            <div class="campo"><label>Características</label><div class="filtros-rapidos"><div><input type="checkbox" id="filtro-20mm" class="filtro-toggle-input"><label for="filtro-20mm" class="filtro-toggle-label">20mm</label></div><div><input type="checkbox" id="filtro-ext" class="filtro-toggle-input"><label for="filtro-ext" class="filtro-toggle-label">Acabado EXT</label></div><div><input type="checkbox" id="filtro-dup" class="filtro-toggle-input"><label for="filtro-dup" class="filtro-toggle-label">Modelo DUP</label></div></div></div>
                            <div class="campo"><label>Serie</label><select id="search-serie" data-csv-col="Serie" disabled><option value="">Todas</option></select></div>
                            <div class="campo"><label>Efecto</label><select id="search-efecto" data-csv-col="Efecto" disabled><option value="">Todos</option></select></div>
                            <div class="campo"><label>Color</label><select id="search-color" data-csv-col="COLOR" disabled><option value="">Todos</option></select></div>
                            <div class="campo"><label>Formato</label><select id="search-formato" data-csv-col="FORMATO" disabled><option value="">Todos</option></select></div>
                            <div class="campo"><label>Modelo</label><select id="search-modelo" data-csv-col="MODELO" disabled><option value="">Todos</option></select></div>
                            <div class="campo"><label>Tipo Material</label><select id="search-familia" data-csv-col="Desc_Familia_web" disabled><option value="">Todos</option></select></div>
                            <div class="campo"><label>Clase Resbaladicidad</label><select id="search-resbaladicidad" data-csv-col="en_16165_anexo_c_deslizamiento_pendulo" disabled><option value="">Todas</option></select></div>
                            <div id="status-message">Cargando datos...</div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Historial -->
                <div class="panel oculto" id="history-panel" style="margin-top:24px; max-height: 250px; flex-shrink:0;">
                    <div class="panel-header">
                        <h3 style="margin:0; font-size:1.1em;">Historial de Prescripciones</h3>
                    </div>
                    <div class="panel-body" id="history-list">
                        <p style="color: #999; text-align:center;">No has generado ninguna prescripción todavía.</p>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: RESULTADOS (Galería) -->
            <div class="col-right">
                <div class="panel">
                    <div class="panel-header"><h3 style="margin:0; font-size:1.1em;">Resultados Disponibles</h3></div>
                    <div id="product-results-list">
                        <!-- INICIO MEJORA: Los Skeleton Loaders se insertarán aquí con JS -->
                    </div>
                </div>
            </div>
        </div>


        <!-- ========================================= -->
        <!-- MODO 2: DETALLE (Prescripción)          -->
        <!-- ========================================= -->
        <div id="view-detail" class="view-section">
            
            <div class="col-left">
                <div class="panel">
                    <div class="panel-header">
                        <button id="btn-back-search" class="btn-volver">
                            <!-- INICIO MEJORA: Icono unificado de "volver" -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" /></svg>
                            <!-- FIN MEJORA -->
                            Volver a Búsqueda
                        </button>
                    </div>
                    <div class="panel-body">
                        <div id="detail-image-container"><img id="detail-product-image" src="" alt="Producto"></div>
                        <form id="formulario-prescripcion">
                            <fieldset><legend>Materiales de Colocación</legend><div class="campo"><label>Nombre Adhesivo</label><input type="text" id="adhesivo_nombre" value="MARCA ADHESIVO"></div><div class="campo"><label>Fabricante Adhesivo</label><input type="text" id="adhesivo_fabricante" value="NOMBRE FABRICANTE"></div><div class="campo"><label>Tipo Adhesivo (EN 12004)</label><input type="text" id="adhesivo_tipo" value=""></div><div class="campo"><label>Nombre Mortero Juntas</label><input type="text" id="mortero_nombre" value="MARCA MORTERO"></div><div class="campo"><label>Fabricante Mortero</label><input type="text" id="mortero_fabricante" value="NOMBRE FABRICANTE"></div></fieldset>
                            <fieldset><legend>Detalles Ejecución</legend><div class="campo"><label>Ancho junta (mm)</label><input type="number" id="junta_maxima" value="15"></div><div class="campo"><label>Ancho perimetral (mm)</label><input type="number" id="junta_perimetral" value="5"></div></fieldset>
                            <input type="hidden" id="tipo_material"><input type="hidden" id="fabricante" value="PAMESA CERÁMICA"><input type="hidden" id="coleccion"><input type="hidden" id="color"><input type="hidden" id="aspecto"><input type="hidden" id="dim_ancho"><input type="hidden" id="dim_alto"><input type="hidden" id="dim_espesor"><input type="hidden" id="desviacion" value="0,15%"><input type="hidden" id="norma_dimensiones" value="UNE-EN ISO10545-2, ISO 13006:2018 UNE-EN 14411:2016"><input type="hidden" id="destonificado"><input type="hidden" id="absorcion_agua"><input type="hidden" id="clase_resbaladicidad"><input type="hidden" id="valor_rd"><input type="hidden" id="uso_transito" value="tránsito intenso"><input type="hidden" id="resistencia_manchas"><input type="hidden" id="resistencia_quimica"><input type="hidden" id="modulo_rotura"><input type="hidden" id="carga_rotura">
                        </form>
                        <button id="btn-descargar-imagen" class="btn-accion secundario" style="width:100%; margin-top:10px;">Descargar Imagen JPG</button>
                    </div>
                </div>
            </div>

            <div class="col-right">
                <div class="panel">
                    <div class="panel-header">
                        <h3 style="margin:0; font-size:1.1em;">Prescripción Técnica</h3>
                        <div class="acciones-container">
                            <button id="btn-copiar" class="btn-accion">Copiar</button><button id="btn-descargar-txt" class="btn-accion">TXT</button><button id="btn-descargar-pdf" class="btn-accion">PDF</button>
                            <a id="link-dap" href="#" target="_blank" class="btn-accion secundario">DAP</a><a id="link-dop" href="#" target="_blank" class="btn-accion secundario">DoP</a>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div style="margin-bottom: 24px; display:flex; gap:12px; flex-wrap:wrap;">
                            <a href="https://www.pamesa.com/ERP/4.0/empresas/151/045/ficheros/t00030006/44/RECOMENDACIONES_PARA_LA_INSTALACION_DE_PRODUCTOS_CERAMICOS__PGEv3.pdf" target="_blank" class="btn-accion secundario" style="font-size:0.8em; padding: 5px 10px;">Guía Instalación</a>
                            <a href="https://www.pamesa.com/ERP/4.0/empresas/151/045/ficheros/t00030006/99/Pamesa_I_ES-Baldosa_2024.pdf" target="_blank" class="btn-accion secundario" style="font-size:0.8em; padding: 5px 10px;">Seguridad</a>
                        </div>
                        <pre id="texto-generado"></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- INICIO MEJORA: Modal de Imagen (Lightbox) -->
    <div id="image-modal-overlay">
        <div id="modal-content">
            <img src="" id="modal-image" alt="Vista ampliada del producto">
            <button id="modal-close-btn" title="Cerrar">&times;</button>
        </div>
    </div>
    <!-- FIN MEJORA -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMENTOS DEL DOM ---
    const ui = {
        loginOverlay: document.getElementById('login-overlay'),
        loginButton: document.getElementById('login-button'),
        loginUsername: document.getElementById('login-username'),
        loginPassword: document.getElementById('login-password'),
        loginError: document.getElementById('login-error'),
        userInfo: document.getElementById('user-info'),
        userGreeting: document.getElementById('user-greeting'),
        logoutLink: document.getElementById('logout-link'),
        historyPanel: document.getElementById('history-panel'),
        historyList: document.getElementById('history-list'),
        viewSearch: document.getElementById('view-search'),
        viewDetail: document.getElementById('view-detail'),
        btnBackSearch: document.getElementById('btn-back-search'),
        formulario: document.getElementById('formulario-prescripcion'),
        statusMessage: document.getElementById('status-message'),
        btnClearFilters: document.getElementById('btn-clear-filters'),
        searchKeyword: document.getElementById('search-keyword'),
        quickFilters: Array.from(document.querySelectorAll('.filtro-toggle-input')),
        allSelectFilters: Array.from(document.querySelectorAll('select[data-csv-col]')).reduce((acc, select) => {
            acc[select.dataset.csvCol] = select;
            return acc;
        }, {}),
        productResultsList: document.getElementById('product-results-list'),
        detailImage: document.getElementById('detail-product-image'),
        detailImageContainer: document.getElementById('detail-image-container'),
        output: document.getElementById('texto-generado'),
        btnCopiar: document.getElementById('btn-copiar'),
        btnDescargarTxt: document.getElementById('btn-descargar-txt'),
        btnDescargarPdf: document.getElementById('btn-descargar-pdf'),
        btnDescargarImagen: document.getElementById('btn-descargar-imagen'),
        linkDAP: document.getElementById('link-dap'),
        linkDOP: document.getElementById('link-dop'),
        modalOverlay: document.getElementById('image-modal-overlay'),
        modalImage: document.getElementById('modal-image'),
        modalCloseBtn: document.getElementById('modal-close-btn')
    };

    // --- ESTADO DE LA APLICACIÓN ---
    let csvData = [];
    let selectedProductIndex = null;
    let currentUser = null;
    const MASTER_PASSWORD = 'pamesa2025';
    
    const revestimientoTypes = [
        'Revestimiento pasta blanca no rectificada',
        'Revestimiento pasta roja no rectificado',
        'Revestimiento pasta blanca rectificada'
    ];
    
    const pavimentoTemplate = `Suministro y ejecución de pavimento con <span class="resaltado">{tipo_material}</span>, de aspecto <span class="resaltado">{aspecto}</span>, colección <span class="resaltado">{coleccion}</span>, color <span class="resaltado">{color}</span> de <span class="resaltado">{fabricante}</span>. Conformado por prensado en seco, tratado en monococción a temperatura de 1200ºC.\n\nCerámica con dimensiones nominales de (Ancho x Alto x Espesor) <span class="resaltado">{dim_ancho}</span>x<span class="resaltado">{dim_alto}</span>x<span class="resaltado">{dim_espesor}</span> cm, desviación de longitud/anchura, rectitud de lados, ortogonalidad y planimetría inferior a <span class="resaltado">{desviacion}</span> (<span class="resaltado">{norma_dimensiones}</span>).\n\nDestonificado <span class="resaltado">{destonificado}</span>, con una absorción de agua muy baja <span class="resaltado">{absorcion_agua}</span> según ISO 10545-3. Clasificación de suelos según su resbaladicidad <span class="resaltado">{clase_resbaladicidad}</span> (CTE DBSUA), resistencia al deslizamiento <span class="resaltado">{valor_rd}</span> (UNE 41901:2017 EX). Módulo de rotura <span class="resaltado">{modulo_rotura}</span> (ISO-13006:2018 UNE-EN 14411:2016) y carga de rotura <span class="resaltado">{carga_rotura}</span> según ISO10545-4.\n\nPavimento de <span class="resaltado">{uso_transito}</span> conforme a la clasificación de baldosas según uso de la Guía de la Baldosa Cerámica (Documento reconocido DRB 01/11), resistente al choque térmico, al cuarteo, a la helada, a las manchas <span class="resaltado">{resistencia_manchas}</span>, según ISO 10545-14 y a los ataques químicos: <span class="resaltado">{resistencia_quimica}</span>, según ISO 10545-13.\n\nContribuye a los estándares de construcción sostenible y saludable (LEED, BREEAM, WELL) gracias a disponer de Declaración Ambiental de Producto propia (DAP), no ser una fuente emisora de sustancias peligrosas COV’s ni formaldehidos, así como por disponer de contenido de material reciclado >6%. Disponible marcado CE.\n\nCerámica recibida sobre recrecido cementoso sin calefacción radiante (no incluido), apto para la colocación en capa fina y tránsito previsto, con adhesivo de altas prestaciones con excelente adherencia y deformabilidad, <span class="resaltado">{adhesivo_nombre}</span> de <span class="resaltado">{adhesivo_fabricante}</span>, tipo <span class="resaltado">{adhesivo_tipo}</span>, según EN 12004, prescrito de acuerdo a las indicaciones de la UNE 138002 y rejuntadas con mortero de juntas cementoso de fraguado y endurecimiento rápido, <span class="resaltado">{mortero_nombre}</span> de <span class="resaltado">{mortero_fabricante}</span>, según EN 13888, para juntas de hasta <span class="resaltado">{junta_maxima}</span>mm.\n\nI/p.p medios auxiliares. Utilización de p/p de Crucetas Autonivelantes (no incluidas), formación de juntas perimetrales continuas, de anchura no menor de <span class="resaltado">{junta_perimetral}</span> mm, en los límites con paredes, pilares exentos y elevaciones de nivel y, en su caso, juntas de partición intermedias. Respetar juntas estructurales existentes en el soporte. Incluso limpieza y comprobación del grado de humedad de la base. Replanteo de niveles. Replanteo de la disposición de las baldosas y juntas de movimiento. Aplicación del adhesivo. Colocación de las crucetas. Colocación de las baldosas con llana dentada y doble encolado. Relleno, si procede, de las juntas de partición intermedias. Rejuntado. Eliminación y limpieza del material sobrante. Limpieza inicial del pavimento al finalizar la obra y protección hasta entrega de obra. Todo el proceso de colocación se efectuará según indicaciones de la dirección facultativa y norma UNE 138002.`;
    const revestimientoTemplate = `Suministro y ejecución de revestimiento con <span class="resaltado">{tipo_material}</span>, de aspecto <span class="resaltado">{aspecto}</span>, colección <span class="resaltado">{coleccion}</span>, color <span class="resaltado">{color}</span> de <span class="resaltado">{fabricante}</span>.\n\nCerámica con dimensiones nominales (Ancho x Largo x Espesor) <span class="resaltado">{dim_ancho}</span>x<span class="resaltado">{dim_alto}</span>x<span class="resaltado">{dim_espesor}</span> cm, desviación de longitud/anchura, rectitud de lados, ortogonalidad y planimetría inferior a <span class="resaltado">{desviacion}</span> (<span class="resaltado">{norma_dimensiones}</span>).\n\nDestonificado <span class="resaltado">{destonificado}</span> con una absorción de agua <span class="resaltado">{absorcion_agua}</span>, módulo de rotura <span class="resaltado">{modulo_rotura}</span> y fuerza de rotura <span class="resaltado">{carga_rotura}</span> (ISO-13006:2018 UNE-EN 14411:2016).\n\nContribuye a los estándares de construcción sostenible y saludable (LEED, BREEAM, WELL) gracias a disponer de Declaración Ambiental de Producto propia (DAP), no ser una fuente emisora de sustancias peligrosas COVs ni formaldehidos, así como por disponer de contenido de material reciclado >6%.\n\nColocación en capa fina, con adhesivo cementoso tecnológico avanzado, <span class="resaltado">{adhesivo_nombre}</span> de <span class="resaltado">{adhesivo_fabricante}</span>, tipo <span class="resaltado">{adhesivo_tipo}</span> según EN 12004, prescrito de acuerdo a las indicaciones de la UNE 138002 y rejuntadas con mortero de juntas cementoso de fraguado y endurecimiento rápido, <span class="resaltado">{mortero_nombre}</span> de <span class="resaltado">{mortero_fabricante}</span>, según EN 13888, para juntas de hasta <span class="resaltado">{junta_maxima}</span> mm.\n\nI/p.p medios auxiliares. Utilización de p/p de Crucetas Autonivelantes (no incluidas), formación de juntas perimetrales continuas, de anchura no menor de <span class="resaltado">{junta_perimetral}</span> mm, en los límites con paredes, pilares exentos y elevaciones de nivel y, en su caso, juntas de partición intermedias. Respetar juntas estructurales existentes en el soporte. Limpieza y comprobación del grado de humedad de la base. Replanteo de niveles. Replanteo de la disposición de las baldosas y juntas de movimiento. Aplicación del adhesivo. Colocación de las crucetas. Colocación de las baldosas con llana dentada y doble encolado. Relleno, si procede, de las juntas de partición intermedias. Rejuntado. Eliminación y limpieza del material sobrante. Limpieza inicial del pavimento al finalizar la obra y protección hasta entrega de obra. Todo el proceso de colocación se efectuará según indicaciones de la dirección facultativa y norma UNE 138002.`;

    // --- LÓGICA DE LOGIN, SESIÓN E HISTORIAL ---
    function checkLogin() {
        const username = localStorage.getItem('currentUser');
        if (username) {
            currentUser = username;
            ui.userGreeting.textContent = `Hola, ${currentUser}`;
            ui.userInfo.classList.remove('oculto');
            ui.loginOverlay.style.opacity = '0';
            setTimeout(() => ui.loginOverlay.classList.add('oculto'), 300);
            ui.historyPanel.classList.remove('oculto');
            loadDataAndInitializeApp();
            displayHistory();
        } else {
            ui.loginOverlay.classList.remove('oculto');
            ui.loginOverlay.style.opacity = '1';
        }
    }

    function handleLogin() {
        const username = ui.loginUsername.value.trim();
        const password = ui.loginPassword.value.trim();
        ui.loginError.textContent = '';
        if (!username || !password) {
            ui.loginError.textContent = 'Usuario y contraseña son obligatorios.';
            return;
        }
        if (password === MASTER_PASSWORD) {
            localStorage.setItem('currentUser', username);
            checkLogin();
        } else {
            ui.loginError.textContent = 'Contraseña incorrecta.';
            ui.loginPassword.value = '';
        }
    }

    function handleLogout() {
        localStorage.removeItem('currentUser');
        currentUser = null;
        location.search = ''; // Limpiar la URL de filtros
    }
    
    function savePrescriptionToHistory() {
        if (!currentUser || selectedProductIndex === null) return;
        const product = csvData[selectedProductIndex];
        const historyKey = `history_${currentUser}`;
        let history = JSON.parse(localStorage.getItem(historyKey)) || [];
        const newEntry = { model: product.MODELO || 'S/M', color: product.COLOR || 'S/C', id: product['Id.Articulo'] || 'N/A', format: product.FORMATO || 'S/F', finish: product.Acabado || 'S/A', date: new Date().toLocaleString('es-ES') };
        history.unshift(newEntry);
        if (history.length > 20) { history = history.slice(0, 20); }
        localStorage.setItem(historyKey, JSON.stringify(history));
        displayHistory();
    }

    function displayHistory() {
        if (!currentUser) return;
        const historyKey = `history_${currentUser}`;
        const history = JSON.parse(localStorage.getItem(historyKey)) || [];
        if (history.length === 0) {
            ui.historyList.innerHTML = `<p style="color: #999; text-align:center;">Aún no has generado prescripciones.</p>`;
        } else {
            ui.historyList.innerHTML = history.map(item => `
                <div class="history-item">
                    <strong>${item.model} - ${item.color}</strong>
                    <div class="details">ID: ${item.id} | ${item.format} | ${item.finish}</div>
                    <small>${item.date}</small>
                </div>`).join('');
        }
    }

    // --- NAVEGACIÓN (SWITCH DE VISTAS) ---
    function goToSearchMode() {
        ui.viewDetail.classList.remove('active-view');
        ui.viewSearch.classList.add('active-view');
    }

    function goToDetailMode(productIndex) {
        selectedProductIndex = productIndex;
        const product = csvData[productIndex];
        if (product) {
            populateDetailView(product);
            ui.viewSearch.classList.remove('active-view');
            ui.viewDetail.classList.add('active-view');
        }
    }

    // --- RENDERIZADO DETALLE ---
    function populateDetailView(product) {
        // ... (resto del código de populateDetailView sin cambios)
        const productType = product['Desc_Familia_web'] || '';
        document.getElementById('tipo_material').value = productType;
        document.getElementById('coleccion').value = product['MODELO'] || '';
        document.getElementById('color').value = product['COLOR'] || '';
        document.getElementById('aspecto').value = [product['Efecto'], product['Acabado']].filter(Boolean).join(' / ');
        document.getElementById('dim_ancho').value = product['Ancho'] ? product['Ancho'].replace(',', '.') : '';
        document.getElementById('dim_alto').value = product['Alto'] ? product['Alto'].replace(',', '.') : '';
        document.getElementById('dim_espesor').value = product['Espesor(mm)'] ? product['Espesor(mm)'].replace(',', '.') : '';
        document.getElementById('destonificado').value = product['Variacion_cromatica'] || '';
        document.getElementById('absorcion_agua').value = product['iso_10545_3_absorcion_agua'] || '';
        document.getElementById('clase_resbaladicidad').value = product['en_16165_anexo_c_deslizamiento_pendulo'] || '';
        document.getElementById('valor_rd').value = product['(Rd)'] || '';
        document.getElementById('resistencia_manchas').value = product['Resistenci_ a_manchas'] || '';
        document.getElementById('resistencia_quimica').value = product['Resistencia_a_ataques_químicos'] || '';
        document.getElementById('modulo_rotura').value = product['iso_10545_4_resistencia_flexion'] || '';
        document.getElementById('carga_rotura').value = product['iso_10545_4_fuerza_rotura'] || '';
        document.getElementById('adhesivo_tipo').value = product['Adhesivo'] || 'C2';
        document.getElementById('junta_maxima').value = revestimientoTypes.includes(productType) ? "4" : "15";

        const imageUrl = product['imagen_url_web'];
        if (imageUrl && imageUrl.trim() !== "") {
            ui.detailImage.src = imageUrl;
            ui.detailImageContainer.style.display = 'flex';
            ui.btnDescargarImagen.style.display = 'inline-flex';
        } else {
            ui.detailImage.src = ''; 
            ui.detailImageContainer.style.display = 'none';
            ui.btnDescargarImagen.style.display = 'none';
        }

        ui.linkDAP.href = product['declaracion_ambiental_producto'] || '#';
        ui.linkDOP.href = product['declaracion_prestaciones'] || '#';
        if (!product['declaracion_ambiental_producto']) ui.linkDAP.style.display = 'none'; else ui.linkDAP.style.display = 'inline-flex';
        if (!product['declaracion_prestaciones']) ui.linkDOP.style.display = 'none'; else ui.linkDOP.style.display = 'inline-flex';
        generarTexto();
    }

    function generarTexto() {
        if (selectedProductIndex === null) return;
        const values = {};
        for (let el of ui.formulario.elements) { if (el.id) values[el.id] = el.value; }
        const selectedProductType = values['tipo_material'];
        let activeTemplate = revestimientoTypes.includes(selectedProductType) ? revestimientoTemplate : pavimentoTemplate;
        let textoHTML = activeTemplate;
        for (const key in values) {
            textoHTML = textoHTML.replace(new RegExp(`{${key}}`, 'g'), values[key] || '[DATO NO ESPECIFICADO]');
        }
        ui.output.innerHTML = textoHTML;
    }

    // --- INICIO MEJORA: LÓGICA DE ESTADO EN URL ---
    function updateUrlState() {
        const params = new URLSearchParams();
        const keyword = ui.searchKeyword.value.trim();
        if (keyword) params.set('q', keyword);

        ui.quickFilters.forEach(qf => {
            if (qf.checked) params.set(qf.id.replace('filtro-', ''), 'true');
        });
        
        Object.values(ui.allSelectFilters).forEach(select => {
            if (select.value) params.set(select.id.replace('search-', ''), select.value);
        });

        const newUrl = `${window.location.pathname}?${params.toString()}`;
        history.pushState({ path: newUrl }, '', newUrl);
    }

    function applyStateFromUrl() {
        const params = new URLSearchParams(window.location.search);
        
        ui.searchKeyword.value = params.get('q') || '';
        
        ui.quickFilters.forEach(qf => {
            qf.checked = params.get(qf.id.replace('filtro-', '')) === 'true';
        });

        Object.values(ui.allSelectFilters).forEach(select => {
            const paramValue = params.get(select.id.replace('search-', ''));
            if (paramValue) select.value = paramValue;
        });
    }
    // --- FIN MEJORA ---


    // --- LÓGICA DE FILTROS (MODO BÚSQUEDA) ---
    function updateFiltersAndProductList() {
        ui.productResultsList.classList.add('is-loading');

        // Usamos setTimeout para permitir que el navegador aplique la clase .is-loading antes de bloquear el hilo principal
        setTimeout(() => {
            const keyword = ui.searchKeyword.value.trim().toUpperCase();
            let filteredProducts = csvData.filter(product => {
                const keywordMatch = !keyword || (product['Serie'] && product['Serie'].toUpperCase().includes(keyword)) || (product['MODELO'] && product['MODELO'].toUpperCase().includes(keyword)) || (product['Efecto'] && product['Efecto'].toUpperCase().includes(keyword)) || (product['COLOR'] && product['COLOR'].toUpperCase().includes(keyword));
                const is20mm = !document.getElementById('filtro-20mm').checked || (product['Espesor(mm)'] && product['Espesor(mm)'].startsWith('2'));
                const isExt = !document.getElementById('filtro-ext').checked || (product['MODELO'] && product['MODELO'].toUpperCase().includes('EXT'));
                const isDup = !document.getElementById('filtro-dup').checked || (product['MODELO'] && product['MODELO'].toUpperCase().includes('DUP'));
                return keywordMatch && is20mm && isExt && isDup;
            });
            const activeSelectFilters = {};
            Object.keys(ui.allSelectFilters).forEach(key => { if (ui.allSelectFilters[key].value) activeSelectFilters[key] = ui.allSelectFilters[key].value; });
            if (Object.keys(activeSelectFilters).length > 0) {
                filteredProducts = filteredProducts.filter(product => Object.keys(activeSelectFilters).every(key => product[key] === activeSelectFilters[key]));
            }
            
            // Repopulate selects (código sin cambios)
            Object.keys(ui.allSelectFilters).forEach(currentKey => {
                const otherFilters = { ...activeSelectFilters };
                delete otherFilters[currentKey];
                const availableProducts = csvData.filter(product => {
                    const keywordMatch = !keyword || (product['Serie'] && product['Serie'].toUpperCase().includes(keyword)) || (product['MODELO'] && product['MODELO'].toUpperCase().includes(keyword)) || (product['Efecto'] && product['Efecto'].toUpperCase().includes(keyword)) || (product['COLOR'] && product['COLOR'].toUpperCase().includes(keyword));
                    const quickFiltersPass = (!document.getElementById('filtro-20mm').checked || (product['Espesor(mm)'] && product['Espesor(mm)'].startsWith('2'))) && (!document.getElementById('filtro-ext').checked || (product['MODELO'] && product['MODELO'].toUpperCase().includes('EXT'))) && (!document.getElementById('filtro-dup').checked || (product['MODELO'] && product['MODELO'].toUpperCase().includes('DUP')));
                    const otherSelectsPass = Object.keys(otherFilters).every(key => product[key] === otherFilters[key]);
                    return keywordMatch && quickFiltersPass && otherSelectsPass;
                });
                repopulateSelectWithOptions(ui.allSelectFilters[currentKey], availableProducts);
            });
            
            renderProductList(filteredProducts);
            ui.statusMessage.textContent = `${filteredProducts.length} productos encontrados`;

            // INICIO MEJORA: Activar botón de limpiar si hay filtros
            const hasActiveFilters = ui.searchKeyword.value || ui.quickFilters.some(qf => qf.checked) || Object.values(ui.allSelectFilters).some(s => s.value);
            ui.btnClearFilters.classList.toggle('active', hasActiveFilters);
            // FIN MEJORA

            ui.productResultsList.classList.remove('is-loading');
        }, 10); // Un pequeño delay es suficiente
    }

    function repopulateSelectWithOptions(selectElement, availableProducts) {
        // ... (código sin cambios)
        const currentValue = selectElement.value;
        const csvCol = selectElement.dataset.csvCol;
        const counts = availableProducts.reduce((acc, product) => {
            const value = product[csvCol];
            if (value) acc[value] = (acc[value] || 0) + 1;
            return acc;
        }, {});
        const sortedOptions = Object.keys(counts).sort();
        selectElement.innerHTML = `<option value="">Todos (${availableProducts.length})</option>`;
        sortedOptions.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = `${value} (${counts[value]})`;
            if (value === currentValue) option.selected = true;
            selectElement.appendChild(option);
        });
    }

    function renderProductList(products) {
        ui.productResultsList.innerHTML = '';
        if (products.length === 0) {
            ui.productResultsList.innerHTML = `<div class="empty-search-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg><p>No se encontraron productos con estos filtros.</p></div>`;
            return;
        }
        products.forEach(product => {
            const originalIndex = csvData.findIndex(p => p === product);
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.index = originalIndex;

            const imgUrl = product['imagen_url_web'];
            let imgHTML = '<div class="card-no-thumb">Sin foto</div>';
            if (imgUrl && imgUrl.trim() !== "") {
                imgHTML = `<img src="${imgUrl}" class="card-thumb" alt="mini" loading="lazy" onerror="this.parentNode.innerHTML='<div class=\'card-no-thumb\'>Error</div>'">`;
            }

            const typeTag = product['Desc_Familia_web'] ? `<span class="tag">${product['Desc_Familia_web'].split(' ')[0]}</span>` : '';
            const classTag = product['en_16165_anexo_c_deslizamiento_pendulo'] ? `<span class="tag">C${product['en_16165_anexo_c_deslizamiento_pendulo']}</span>` : '';
            let espesorTag = '';
            const espesorValue = product['Espesor(mm)'];
            if (espesorValue) {
                const espesorCm = parseFloat(espesorValue.replace(',', '.'));
                if (!isNaN(espesorCm)) {
                    const espesorMm = espesorCm * 10;
                    espesorTag = `<span class="tag">${espesorMm.toLocaleString('es-ES')} mm</span>`;
                }
            }

            card.innerHTML = `<div class="card-thumb-container">${imgHTML}</div><div class="card-info"><h4 class="card-title">${product.MODELO || 'S/M'} - ${product.COLOR || 'S/C'}</h4><p class="card-sub">${product.FORMATO || ''} | ${product.Acabado || ''}</p><div class="card-tags">${typeTag}${classTag}${espesorTag}</div></div>`;
            card.addEventListener('click', () => goToDetailMode(originalIndex));
            
            const thumbContainer = card.querySelector('.card-thumb-container');
            if (imgUrl && imgUrl.trim() !== "") {
                thumbContainer.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openModal(imgUrl);
                });
            }
            ui.productResultsList.appendChild(card);
        });
    }
    
    function clearFilters() {
         ui.searchKeyword.value = '';
         ui.quickFilters.forEach(qf => qf.checked = false);
         Object.values(ui.allSelectFilters).forEach(select => select.value = '');
         updateFiltersAndProductList();
         updateUrlState(); // INICIO MEJORA: Actualizar URL al limpiar
    }

    // --- CARGA DATOS ---
    async function loadDataAndInitializeApp() {
        const csvFilePath = 'BD_contrac_presto4.csv'; 
        ui.statusMessage.textContent = 'Cargando catálogo...';
        // --- INICIO MEJORA: Mostrar Skeleton Loaders ---
        let skeletonHTML = '';
        for (let i = 0; i < 9; i++) {
            skeletonHTML += `<div class="skeleton-card"><div class="skeleton-thumb"></div><div class="skeleton-info"><div class="skeleton-line title"></div><div class="skeleton-line sub"></div></div></div>`;
        }
        ui.productResultsList.innerHTML = skeletonHTML;
        // --- FIN MEJORA ---
        
        try {
            const response = await fetch(csvFilePath);
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            const csvText = await response.text();
            csvData = parseCSV(csvText);
            if (csvData.length === 0) throw new Error("CSV vacío o inválido.");
            
            Object.values(ui.allSelectFilters).forEach(select => { select.disabled = false; });
            
            applyStateFromUrl(); // INICIO MEJORA: Aplicar filtros de la URL
            updateFiltersAndProductList(); // Renderizar con los filtros aplicados
        } catch (error) {
            ui.statusMessage.textContent = `Error: No se pudo cargar el catálogo.`;
            ui.productResultsList.innerHTML = `<div class="empty-search-state"><p>Error al cargar productos.</p></div>`;
            console.error(error);
        }
    }

    function parseCSV(text) {
        const lines = text.trim().split(/\r\n|\n/);
        if (lines.length < 2) return [];
        
        const headerLine = lines[0].replace(/^\uFEFF/, '');
        const delimiter = (headerLine.match(/;/g) || []).length > (headerLine.match(/,/g) || []).length ? ';' : ',';
        const headers = headerLine.split(delimiter).map(h => h.trim());
        
        const data = [];
        
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line === '') continue; // Salta líneas totalmente vacías
            
            const values = line.split(delimiter);
            
            // 1. Validación de estructura básica
            if (values.length < headers.length) continue;
            
            // 2. SOLUCIÓN AL PROBLEMA: 
            // Verificar si la fila está vacía de contenido real (solo tiene ;;;;)
            // Si todos los campos están vacíos, saltamos la línea.
            const isRowEmpty = values.every(val => val.trim() === '');
            if (isRowEmpty) continue;

            const entry = {};
            let hasKeyData = false; // Bandera para saber si tiene datos clave

            headers.forEach((header, index) => {
                const val = values[index] ? values[index].trim() : '';
                entry[header] = val;
            });

            // 3. FILTRO DE SEGURIDAD ADICIONAL:
            // Si no hay MODELO, no consideramos que sea un producto válido.
            // Esto elimina definitivamente los "S/M".
            if (!entry['MODELO'] || entry['MODELO'] === "") continue;

            data.push(entry);
        }
        return data;
    }

    // --- EXPORTACIÓN (PDF / TXT / IMG) ---
    async function generarPDF() {
        // ... (código sin cambios)
        if (selectedProductIndex === null) return;
        ui.btnDescargarPdf.textContent = '...'; ui.btnDescargarPdf.disabled = true;
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const product = csvData[selectedProductIndex];
            const M_LEFT = 20, M_TOP = 20, WIDTH = 170;
            let y = M_TOP;
            const imgToBase64 = async (url) => {
                if (!url) return null;
                try {
                    const res = await fetch(url); const blob = await res.blob();
                    return new Promise((r) => { const reader = new FileReader(); reader.onloadend = () => r(reader.result); reader.readAsDataURL(blob); });
                } catch { return null; }
            };
            const logo = await imgToBase64('LOGO-PAMESA.jpg');
            if (logo) doc.addImage(logo, 'JPEG', M_LEFT, 10, 50, 10);
            doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.text('Prescripción Técnica', 210 - 20, 16, { align: 'right' });
            y = 25; doc.setDrawColor(206, 23, 25); doc.line(M_LEFT, y, 210-20, y); y += 10;
            doc.setFontSize(16); doc.setTextColor(206, 23, 25); doc.text(`${product.MODELO} - ${product.COLOR}`, M_LEFT, y); y += 10;
            const prodImg = await imgToBase64(ui.detailImage.src);
            let textX = M_LEFT; let textW = WIDTH;
            if (prodImg) { doc.addImage(prodImg, 'JPEG', M_LEFT, y, 60, 60); textX = M_LEFT + 65; textW = WIDTH - 65; }
            const rawHTML = ui.output.innerHTML;
            const cleanText = rawHTML.replace(/<br\s*\/?>/gi, '\n').replace(/&nbsp;/g, ' ');
            const paragraphs = cleanText.split('\n');
            doc.setFontSize(9); doc.setTextColor(0,0,0); let currentY = y;
            paragraphs.forEach(para => {
                if (!para.trim()) { currentY += 4; return; }
                if (prodImg && currentY > (y + 65)) { textX = M_LEFT; textW = WIDTH; }
                const parts = para.split(/(<span class="resaltado">.*?<\/span>)/g);
                let lineWidth = 0; const words = [];
                parts.forEach(part => {
                    const isBold = part.startsWith('<span'); const content = isBold ? part.replace(/<[^>]+>/g, '') : part;
                    content.split(' ').forEach(w => { if(w) words.push({ text: w + ' ', bold: isBold }); });
                });
                words.forEach(wordObj => {
                    doc.setFont('helvetica', wordObj.bold ? 'bold' : 'normal'); doc.setTextColor(wordObj.bold ? '#ce1719' : '#333333');
                    const wWidth = doc.getStringUnitWidth(wordObj.text) * 9 / doc.internal.scaleFactor;
                    if (lineWidth + wWidth > textW) {
                        currentY += 4; lineWidth = 0;
                        if (prodImg && currentY > (y + 65)) { textX = M_LEFT; textW = WIDTH; }
                        if (currentY > 280) { doc.addPage(); currentY = 20; textX = M_LEFT; textW = WIDTH; }
                    }
                    doc.text(wordObj.text, textX + lineWidth, currentY); lineWidth += wWidth;
                });
                currentY += 5;
            });
            const pages = doc.internal.getNumberOfPages();
            for(let i=1; i<=pages; i++) { doc.setPage(i); doc.setFontSize(8); doc.setTextColor(150); doc.text(`Pág ${i}/${pages} | ${new Date().toLocaleDateString()}`, 105, 290, { align: 'center' }); }
            const fname = `Prescripcion_${product.MODELO}_${product.COLOR}.pdf`;
            doc.save(fname);
        } catch (e) { console.error(e); alert('Error al generar PDF'); } 
        finally { ui.btnDescargarPdf.textContent = 'PDF'; ui.btnDescargarPdf.disabled = false; }
    }

    // --- Lógica del Modal de Imagen ---
    function openModal(imageUrl) {
        if (imageUrl) { ui.modalImage.src = imageUrl; ui.modalOverlay.classList.add('visible'); }
    }
    function closeModal() {
        ui.modalOverlay.classList.remove('visible');
        setTimeout(() => { ui.modalImage.src = ''; }, 300);
    }
    
    // --- EVENTOS ---
    ui.loginButton.addEventListener('click', handleLogin);
    [ui.loginUsername, ui.loginPassword].forEach(el => el.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); }));
    ui.logoutLink.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });

    ui.btnBackSearch.addEventListener('click', goToSearchMode);
    ui.btnClearFilters.addEventListener('click', clearFilters);
    
    // --- INICIO MEJORA: Eventos de filtro actualizan la URL ---
    const updateAll = () => { updateFiltersAndProductList(); updateUrlState(); };
    ui.searchKeyword.addEventListener('input', updateAll);
    ui.quickFilters.forEach(el => el.addEventListener('change', updateAll));
    Object.values(ui.allSelectFilters).forEach(el => el.addEventListener('change', updateAll));
    // --- FIN MEJORA ---

    Array.from(ui.formulario.elements).forEach(el => el.addEventListener('input', generarTexto));
    
    ui.btnCopiar.addEventListener('click', () => {
        savePrescriptionToHistory();
        navigator.clipboard.writeText(ui.output.textContent);
        const prev = ui.btnCopiar.textContent;
        ui.btnCopiar.textContent = '¡Copiado!';
        setTimeout(() => ui.btnCopiar.textContent = prev, 1500);
    });

    ui.btnDescargarTxt.addEventListener('click', () => {
        savePrescriptionToHistory();
        const blob = new Blob([ui.output.textContent], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = 'prescripcion.txt'; a.click();
    });

    ui.btnDescargarPdf.addEventListener('click', () => {
        savePrescriptionToHistory();
        generarPDF();
    });

    ui.btnDescargarImagen.addEventListener('click', async () => {
        // ... (código sin cambios)
        const url = ui.detailImage.src; if(!url) return;
        try {
            const res = await fetch(url); const blob = await res.blob();
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = 'imagen_producto.jpg'; a.click();
        } catch { window.open(url, '_blank'); }
    });

    // Eventos para el Modal
    ui.detailImageContainer.addEventListener('click', () => { if(ui.detailImage.src) { openModal(ui.detailImage.src); } });
    ui.modalCloseBtn.addEventListener('click', closeModal);
    ui.modalOverlay.addEventListener('click', (e) => { if (e.target === ui.modalOverlay) { closeModal(); } });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && ui.modalOverlay.classList.contains('visible')) { closeModal(); } });

    document.getElementById('texto-generado').addEventListener('copy', () => {
    console.log('Copia detectada mediante selección manual. Registrando en historial.');
    savePrescriptionToHistory();

    // Feedback visual opcional para que el usuario sepa que se ha registrado
    const btnCopiar = ui.btnCopiar;
    const prevText = btnCopiar.textContent;
    btnCopiar.textContent = '¡Registrado!';
    btnCopiar.style.backgroundColor = '#28a745'; // Un color de éxito
    setTimeout(() => {
        btnCopiar.textContent = prevText;
        btnCopiar.style.backgroundColor = ''; // Vuelve al color original
    }, 1500);
});

    // INICIO DE LA APLICACIÓN
    checkLogin();
    // Por defecto, la vista de búsqueda es la activa al principio
    ui.viewSearch.classList.add('active-view');
});
</script>
</body>
</html>