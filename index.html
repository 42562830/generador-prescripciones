<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Prescripciones de Obra v3.1 - Pamesa Cerámica</title>
    
    <!-- LIBRERÍAS EXTERNAS -->
    <!-- Fuente Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Librería jsPDF para generar el PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --color-principal: #ce1719;
            --color-principal-hover: #b51517;
            --color-secundario: #4a4a4a;
            --color-secundario-hover: #333333;
            --color-blanco: #ffffff;
            --color-texto-principal: #222;
            --color-texto-secundario: #555;
            --color-titulos: #000;
            --color-fondo: #f9fafb;
            --color-fondo-suave: #f8f8f8;
            --color-borde-suave: #e5e5e5;
            --font-main: 'Montserrat', sans-serif;
            --radio-borde: 8px;
            --sombra-suave: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --max-width-container: 1800px; /* Aumentado para aprovechar pantallas grandes */
        }

        /* --- ESTILOS BASE Y RESET --- */
        * { box-sizing: border-box; }
        html { height: 100%; }
        body {
            font-family: var(--font-main);
            background-color: var(--color-fondo);
            color: var(--color-texto-principal);
            margin: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- CABECERA --- */
        .header-corporativo {
            background-color: var(--color-blanco);
            padding: 15px 30px;
            border-bottom: 1px solid var(--color-borde-suave);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            z-index: 10;
            flex-shrink: 0;
        }
        .header-container {
            max-width: var(--max-width-container);
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-corporativo img { height: 35px; width: auto; }
        .header-corporativo h1 {
            font-size: 1.4em; color: var(--color-titulos);
            font-weight: 600; margin: 0; text-align: right;
        }
        
        /* --- ESTRUCTURA DE VISTAS (MODOS) --- */
        .main-content { 
            padding: 20px; 
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }

        /* Clase para ocultar/mostrar vistas completas */
        .view-section {
            display: none; /* Oculto por defecto */
            height: 100%;
            width: 100%;
            max-width: var(--max-width-container);
            margin: 0 auto;
            gap: 20px;
        }

        .view-section.active-view {
            display: flex; /* Solo se muestra la activa */
        }

        /* --- COLUMNAS Y PANELES --- */
        .col-left { flex: 1; min-width: 350px; max-width: 450px; display: flex; flex-direction: column; }
        .col-right { flex: 2; display: flex; flex-direction: column; min-width: 0; }

        .panel {
            background-color: var(--color-blanco);
            border-radius: var(--radio-borde);
            box-shadow: var(--sombra-suave);
            border: 1px solid var(--color-borde-suave);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }
        
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--color-borde-suave);
            background-color: #fff;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-body {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* Scrollbars personalizados */
        .panel-body::-webkit-scrollbar, #product-results-list::-webkit-scrollbar { width: 8px; }
        .panel-body::-webkit-scrollbar-track, #product-results-list::-webkit-scrollbar-track { background: var(--color-fondo-suave); }
        .panel-body::-webkit-scrollbar-thumb, #product-results-list::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 20px; border: 2px solid var(--color-fondo-suave); }
        .panel-body::-webkit-scrollbar-thumb:hover { background-color: #bbb; }

        /* --- MODO 1: BUSCADOR --- */
        /* Panel Filtros */
        #formulario-busqueda { padding: 10px; }
        
        /* Panel Resultados (Lista) */
        #product-results-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); /* Grid responsivo */
            gap: 15px;
            padding: 20px;
            overflow-y: auto;
            height: 100%;
            background-color: var(--color-fondo-suave);
        }

        /* Tarjeta de Producto v2.0 */
        .product-card {
            background: white;
            border: 1px solid var(--color-borde-suave);
            border-radius: var(--radio-borde);
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--color-principal);
        }
        
        .card-thumb-container {
            width: 80px;
            height: 80px;
            border-radius: 6px;
            background-color: #eee;
            flex-shrink: 0;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .card-thumb {
            width: 100%; height: 100%; object-fit: cover;
        }
        .card-no-thumb {
            font-size: 0.7em; color: #999; text-align: center; padding: 5px;
        }

        .card-info { flex-grow: 1; min-width: 0; }
        .card-title {
            font-weight: 700; font-size: 1em; color: var(--color-texto-principal);
            margin: 0 0 5px 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .card-sub {
            font-size: 0.85em; color: var(--color-texto-secundario); margin-bottom: 8px;
        }
        .card-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .tag {
            background: #f0f0f0; color: #555; font-size: 0.7em; padding: 2px 6px; border-radius: 4px; font-weight: 600;
        }

        /* --- MODO 2: DETALLE --- */
        .btn-volver {
            background: none; border: none; 
            color: var(--color-texto-secundario); 
            font-weight: 600; font-size: 0.95em; 
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: color 0.2s;
        }
        .btn-volver:hover { color: var(--color-principal); }
        .btn-volver svg { width: 20px; height: 20px; }

        /* Imagen Grande en Detalle */
        #detail-image-container {
            width: 100%;
            background-color: #fff;
            border: 1px solid var(--color-borde-suave);
            border-radius: var(--radio-borde);
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            margin-bottom: 20px;
        }
        #detail-image {
            width: 100%; height: auto; object-fit: contain;
        }

        /* Texto Generado en Detalle */
        #texto-generado {
            font-family: var(--font-main);
            font-size: 1.05em; /* Texto más grande */
            line-height: 1.9;
            color: #333;
            white-space: pre-wrap;
            margin: 0;
        }
        
        .resaltado { color: var(--color-principal); font-weight: 600; }

        /* --- COMPONENTES COMUNES --- */
        fieldset {
            border: 1px solid var(--color-borde-suave);
            border-radius: var(--radio-borde);
            padding: 15px; margin: 0 0 20px 0;
        }
        legend {
            font-weight: 600; font-size: 1em; color: var(--color-principal); padding: 0 5px;
        }
        .campo { margin-bottom: 12px; }
        .campo label {
            display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.85em; color: #555;
        }
        .campo input, .campo select {
            width: 100%; padding: 10px; border: 1px solid var(--color-borde-suave);
            border-radius: 6px; font-family: var(--font-main); font-size: 0.95em;
        }
        .campo input:focus, .campo select:focus {
            outline: none; border-color: var(--color-principal);
        }

        /* Botones de Acción */
        .acciones-container {
            display: flex; flex-wrap: wrap; gap: 10px;
        }
        .btn-accion {
            background-color: var(--color-principal); color: white; border: none; padding: 10px 18px; border-radius: 6px;
            cursor: pointer; font-weight: 600; font-size: 0.9em; text-decoration: none;
            display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .btn-accion:hover { background-color: var(--color-principal-hover); transform: translateY(-1px); }
        .btn-accion.secundario { background-color: var(--color-secundario); }
        .btn-accion.secundario:hover { background-color: var(--color-secundario-hover); }

        /* Filtros Rápidos */
        .filtros-rapidos { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .filtro-toggle-label {
            padding: 6px 12px; border: 1px solid var(--color-borde-suave); border-radius: 20px;
            font-size: 0.8em; cursor: pointer; background: #f8f8f8; transition: all 0.2s;
        }
        .filtro-toggle-input:checked + .filtro-toggle-label {
            background-color: var(--color-principal); color: white; border-color: var(--color-principal);
        }

        #status-message {
            text-align: center; font-weight: 600; margin-top: 10px; font-size: 0.9em; color: #666;
        }
        .btn-limpiar {
            background: none; border: 1px solid var(--color-principal); color: var(--color-principal);
            border-radius: 4px; padding: 4px 10px; font-size: 0.8em; cursor: pointer;
        }

        /* Mensaje vacío */
        .empty-search-state {
            grid-column: 1 / -1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #999; text-align: center;
        }
        .empty-search-state svg { width: 60px; height: 60px; margin-bottom: 15px; opacity: 0.3; }

        /* Oculto helper */
        .oculto { display: none !important; }

        /* Responsive */
        @media (max-width: 900px) {
            .container { flex-direction: column; }
            .col-left, .col-right { width: 100%; max-width: none; flex: none; }
            .view-section { flex-direction: column; overflow-y: auto; display: none; } /* Reset display none */
            .view-section.active-view { display: block; }
            .panel { height: auto; margin-bottom: 20px; overflow: visible; }
            #product-results-list { height: 400px; overflow-y: auto; }
        }
    </style>
</head>
<body>

    <header class="header-corporativo">
        <div class="header-container">
            <img src="LOGO-PAMESA.jpg" alt="Logo Pamesa Cerámica" onerror="this.style.display='none'">
            <h1>Generador de Prescripciones de Obra v3.0</h1>
        </div>
    </header>

    <main class="main-content">
        
        <!-- ========================================= -->
        <!-- MODO 1: BÚSQUEDA (Vista por defecto) -->
        <!-- ========================================= -->
        <div id="view-search" class="view-section active-view">
            
            <!-- Columna Izquierda: FILTROS -->
            <div class="col-left">
                <div class="panel">
                    <div class="panel-header">
                        <h3 style="margin:0; font-size:1.1em;">Filtros de Búsqueda</h3>
                        <button type="button" id="btn-clear-filters" class="btn-limpiar">Limpiar</button>
                    </div>
                    <div class="panel-body">
                        <div id="formulario-busqueda">
                            
                            <!-- Filtros Rápidos -->
                            <div class="campo">
                                <label>Características</label>
                                <div class="filtros-rapidos">
                                    <div><input type="checkbox" id="filtro-20mm" class="filtro-toggle-input"><label for="filtro-20mm" class="filtro-toggle-label">20mm</label></div>
                                    <div><input type="checkbox" id="filtro-ext" class="filtro-toggle-input"><label for="filtro-ext" class="filtro-toggle-label">Acabado EXT</label></div>
                                    <div><input type="checkbox" id="filtro-dup" class="filtro-toggle-input"><label for="filtro-dup" class="filtro-toggle-label">Modelo DUP</label></div>
                                </div>
                            </div>

                            <!-- Filtros Principales -->
                            <div class="campo"><label>Serie</label><select id="search-serie" data-csv-col="Serie" disabled><option value="">Todas</option></select></div>
                            <div class="campo"><label>Efecto</label><select id="search-efecto" data-csv-col="Efecto" disabled><option value="">Todos</option></select></div>
                            <div class="campo"><label>Color</label><select id="search-color" data-csv-col="COLOR" disabled><option value="">Todos</option></select></div>
                            
                            <!-- Filtros Secundarios -->
                            <div class="campo"><label>Formato</label><select id="search-formato" data-csv-col="FORMATO" disabled><option value="">Todos</option></select></div>
                            <div class="campo"><label>Modelo</label><select id="search-modelo" data-csv-col="MODELO" disabled><option value="">Todos</option></select></div>
                            <div class="campo"><label>Tipo Material</label><select id="search-familia" data-csv-col="Desc_Familia_web" disabled><option value="">Todos</option></select></div>
                            <div class="campo"><label>Clase Resbaladicidad</label><select id="search-resbaladicidad" data-csv-col="en_16165_anexo_c_deslizamiento_pendulo" disabled><option value="">Todas</option></select></div>

                            <div id="status-message">Cargando datos...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: RESULTADOS (Galería) -->
            <div class="col-right">
                <div class="panel">
                    <div class="panel-header">
                        <h3 style="margin:0; font-size:1.1em;">Resultados Disponibles</h3>
                        <!-- Aquí podrías poner un contador o ordenación si quisieras -->
                    </div>
                    <!-- Contenedor de la lista de tarjetas -->
                    <div id="product-results-list">
                        <!-- JS inyectará las tarjetas aquí -->
                        <div class="empty-search-state">
                            <p>Cargando productos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- ========================================= -->
        <!-- MODO 2: DETALLE (Prescripción) -->
        <!-- ========================================= -->
        <div id="view-detail" class="view-section">
            
            <!-- Columna Izquierda: CONTROL Y EDICIÓN -->
            <div class="col-left">
                <div class="panel">
                    <div class="panel-header">
                        <button id="btn-back-search" class="btn-volver">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                            Volver a Búsqueda
                        </button>
                    </div>
                    <div class="panel-body">
                        
                        <!-- Imagen del Producto -->
                        <div id="detail-image-container">
                            <img id="detail-product-image" src="" alt="Producto">
                        </div>

                        <!-- Formulario Editable -->
                        <form id="formulario-prescripcion">
                            <fieldset>
                                <legend>Materiales de Colocación</legend>
                                <div class="campo"><label>Nombre Adhesivo</label><input type="text" id="adhesivo_nombre" value="MARCA ADHESIVO"></div>
                                <div class="campo"><label>Fabricante Adhesivo</label><input type="text" id="adhesivo_fabricante" value="NOMBRE FABRICANTE"></div>
                                <div class="campo"><label>Tipo Adhesivo (EN 12004)</label><input type="text" id="adhesivo_tipo" value=""></div>
                                <div class="campo"><label>Nombre Mortero Juntas</label><input type="text" id="mortero_nombre" value="MARCA MORTERO"></div>
                                <div class="campo"><label>Fabricante Mortero</label><input type="text" id="mortero_fabricante" value="NOMBRE FABRICANTE"></div>
                            </fieldset>

                            <fieldset>
                                <legend>Detalles Ejecución</legend>
                                <div class="campo"><label>Ancho junta (mm)</label><input type="number" id="junta_maxima" value="15"></div>
                                <div class="campo"><label>Ancho perimetral (mm)</label><input type="number" id="junta_perimetral" value="5"></div>
                            </fieldset>

                            <!-- Campos Ocultos (Datos Fijos del CSV) -->
                            <input type="hidden" id="tipo_material"><input type="hidden" id="fabricante" value="PAMESA CERÁMICA"><input type="hidden" id="coleccion"><input type="hidden" id="color"><input type="hidden" id="aspecto"><input type="hidden" id="dim_ancho"><input type="hidden" id="dim_alto"><input type="hidden" id="dim_espesor"><input type="hidden" id="desviacion" value="0,15%"><input type="hidden" id="norma_dimensiones" value="UNE-EN ISO10545-2, ISO 13006:2018 UNE-EN 14411:2016"><input type="hidden" id="destonificado"><input type="hidden" id="absorcion_agua"><input type="hidden" id="clase_resbaladicidad"><input type="hidden" id="valor_rd"><input type="hidden" id="uso_transito" value="tránsito intenso"><input type="hidden" id="resistencia_manchas"><input type="hidden" id="resistencia_quimica"><input type="hidden" id="modulo_rotura"><input type="hidden" id="carga_rotura">
                        </form>
                        
                        <!-- Botón Descargar Imagen -->
                        <button id="btn-descargar-imagen" class="btn-accion secundario" style="width:100%; margin-top:10px;">Descargar Imagen JPG</button>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: PRESCRIPCIÓN FINAL -->
            <div class="col-right">
                <div class="panel">
                    <div class="panel-header">
                        <h3 style="margin:0; font-size:1.1em;">Prescripción Técnica</h3>
                        <div class="acciones-container">
                            <button id="btn-copiar" class="btn-accion">Copiar</button>
                            <button id="btn-descargar-txt" class="btn-accion">TXT</button>
                            <button id="btn-descargar-pdf" class="btn-accion">PDF</button>
                            <a id="link-dap" href="#" target="_blank" class="btn-accion secundario">DAP</a>
                            <a id="link-dop" href="#" target="_blank" class="btn-accion secundario">DoP</a>
                        </div>
                    </div>
                    <div class="panel-body">
                        <!-- Enlaces adicionales -->
                        <div style="margin-bottom: 20px; display:flex; gap:10px; flex-wrap:wrap;">
                            <a href="https://www.pamesa.com/ERP/4.0/empresas/151/045/ficheros/t00030006/44/RECOMENDACIONES_PARA_LA_INSTALACION_DE_PRODUCTOS_CERAMICOS__PGEv3.pdf" target="_blank" class="btn-accion secundario" style="font-size:0.8em; padding: 5px 10px;">Guía Instalación</a>
                            <a href="https://www.pamesa.com/ERP/4.0/empresas/151/045/ficheros/t00030006/99/Pamesa_I_ES-Baldosa_2024.pdf" target="_blank" class="btn-accion secundario" style="font-size:0.8em; padding: 5px 10px;">Seguridad</a>
                        </div>

                        <!-- El texto generado ocupa todo el espacio aquí -->
                        <pre id="texto-generado"></pre>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMENTOS DEL DOM ---
    const ui = {
        // Vistas
        viewSearch: document.getElementById('view-search'),
        viewDetail: document.getElementById('view-detail'),
        btnBackSearch: document.getElementById('btn-back-search'),

        // Formulario y Filtros
        formulario: document.getElementById('formulario-prescripcion'),
        statusMessage: document.getElementById('status-message'),
        btnClearFilters: document.getElementById('btn-clear-filters'),
        quickFilters: Array.from(document.querySelectorAll('.filtro-toggle-input')),
        allSelectFilters: Array.from(document.querySelectorAll('select[data-csv-col]')).reduce((acc, select) => {
            acc[select.dataset.csvCol] = select;
            return acc;
        }, {}),

        // Resultados Búsqueda
        productResultsList: document.getElementById('product-results-list'),

        // Detalle Producto
        detailImage: document.getElementById('detail-product-image'),
        detailImageContainer: document.getElementById('detail-image-container'),
        output: document.getElementById('texto-generado'),
        
        // Botones Acción Detalle
        btnCopiar: document.getElementById('btn-copiar'),
        btnDescargarTxt: document.getElementById('btn-descargar-txt'),
        btnDescargarPdf: document.getElementById('btn-descargar-pdf'),
        btnDescargarImagen: document.getElementById('btn-descargar-imagen'),
        linkDAP: document.getElementById('link-dap'),
        linkDOP: document.getElementById('link-dop')
    };

    // --- ESTADO DE LA APLICACIÓN ---
    let csvData = [];
    let selectedProductIndex = null;
    const revestimientoTypes = [
        'Revestimiento pasta blanca no rectificada',
        'Revestimiento pasta roja no rectificado',
        'Revestimiento pasta blanca rectificada'
    ];
    
    // Plantillas (Iguales que antes)
    const pavimentoTemplate = `Suministro y ejecución de pavimento con <span class="resaltado">{tipo_material}</span>, de aspecto <span class="resaltado">{aspecto}</span>, colección <span class="resaltado">{coleccion}</span>, color <span class="resaltado">{color}</span> de <span class="resaltado">{fabricante}</span>. Conformado por prensado en seco, tratado en monococción a temperatura de 1200ºC.\n\nCerámica con dimensiones nominales de (Ancho x Alto x Espesor) <span class="resaltado">{dim_ancho}</span>x<span class="resaltado">{dim_alto}</span>x<span class="resaltado">{dim_espesor}</span> cm, desviación de longitud/anchura, rectitud de lados, ortogonalidad y planimetría inferior a <span class="resaltado">{desviacion}</span> (<span class="resaltado">{norma_dimensiones}</span>).\n\nDestonificado <span class="resaltado">{destonificado}</span>, con una absorción de agua muy baja <span class="resaltado">{absorcion_agua}</span> según ISO 10545-3. Clasificación de suelos según su resbaladicidad <span class="resaltado">{clase_resbaladicidad}</span> (CTE DBSUA), resistencia al deslizamiento <span class="resaltado">{valor_rd}</span> (UNE 41901:2017 EX). Módulo de rotura <span class="resaltado">{modulo_rotura}</span> (ISO-13006:2018 UNE-EN 14411:2016) y carga de rotura <span class="resaltado">{carga_rotura}</span> según ISO10545-4.\n\nPavimento de <span class="resaltado">{uso_transito}</span> conforme a la clasificación de baldosas según uso de la Guía de la Baldosa Cerámica (Documento reconocido DRB 01/11), resistente al choque térmico, al cuarteo, a la helada, a las manchas <span class="resaltado">{resistencia_manchas}</span>, según ISO 10545-14 y a los ataques químicos: <span class="resaltado">{resistencia_quimica}</span>, según ISO 10545-13.\n\nContribuye a los estándares de construcción sostenible y saludable (LEED, BREEAM, WELL) gracias a disponer de Declaración Ambiental de Producto propia (DAP), no ser una fuente emisora de sustancias peligrosas COV’s ni formaldehidos, así como por disponer de contenido de material reciclado >6%. Disponible marcado CE.\n\nCerámica recibida sobre recrecido cementoso sin calefacción radiante (no incluido), apto para la colocación en capa fina y tránsito previsto, con adhesivo de altas prestaciones con excelente adherencia y deformabilidad, <span class="resaltado">{adhesivo_nombre}</span> de <span class="resaltado">{adhesivo_fabricante}</span>, tipo <span class="resaltado">{adhesivo_tipo}</span>, según EN 12004, prescrito de acuerdo a las indicaciones de la UNE 138002 y rejuntadas con mortero de juntas cementoso de fraguado y endurecimiento rápido, <span class="resaltado">{mortero_nombre}</span> de <span class="resaltado">{mortero_fabricante}</span>, según EN 13888, para juntas de hasta <span class="resaltado">{junta_maxima}</span>mm.\n\nI/p.p medios auxiliares. Utilización de p/p de Crucetas Autonivelantes (no incluidas), formación de juntas perimetrales continuas, de anchura no menor de <span class="resaltado">{junta_perimetral}</span> mm, en los límites con paredes, pilares exentos y elevaciones de nivel y, en su caso, juntas de partición intermedias. Respetar juntas estructurales existentes en el soporte. Incluso limpieza y comprobación del grado de humedad de la base. Replanteo de niveles. Replanteo de la disposición de las baldosas y juntas de movimiento. Aplicación del adhesivo. Colocación de las crucetas. Colocación de las baldosas con llana dentada y doble encolado. Relleno, si procede, de las juntas de partición intermedias. Rejuntado. Eliminación y limpieza del material sobrante. Limpieza inicial del pavimento al finalizar la obra y protección hasta entrega de obra. Todo el proceso de colocación se efectuará según indicaciones de la dirección facultativa y norma UNE 138002.`;
    
    const revestimientoTemplate = `Suministro y ejecución de revestimiento con <span class="resaltado">{tipo_material}</span>, de aspecto <span class="resaltado">{aspecto}</span>, colección <span class="resaltado">{coleccion}</span>, color <span class="resaltado">{color}</span> de <span class="resaltado">{fabricante}</span>.\n\nCerámica con dimensiones nominales (Ancho x Largo x Espesor) <span class="resaltado">{dim_ancho}</span>x<span class="resaltado">{dim_alto}</span>x<span class="resaltado">{dim_espesor}</span> cm, desviación de longitud/anchura, rectitud de lados, ortogonalidad y planimetría inferior a <span class="resaltado">{desviacion}</span> (<span class="resaltado">{norma_dimensiones}</span>).\n\nDestonificado <span class="resaltado">{destonificado}</span> con una absorción de agua <span class="resaltado">{absorcion_agua}</span>, módulo de rotura <span class="resaltado">{modulo_rotura}</span> y fuerza de rotura <span class="resaltado">{carga_rotura}</span> (ISO-13006:2018 UNE-EN 14411:2016).\n\nContribuye a los estándares de construcción sostenible y saludable (LEED, BREEAM, WELL) gracias a disponer de Declaración Ambiental de Producto propia (DAP), no ser una fuente emisora de sustancias peligrosas COVs ni formaldehidos, así como por disponer de contenido de material reciclado >6%.\n\nColocación en capa fina, con adhesivo cementoso tecnológico avanzado, <span class="resaltado">{adhesivo_nombre}</span> de <span class="resaltado">{adhesivo_fabricante}</span>, tipo <span class="resaltado">{adhesivo_tipo}</span> según EN 12004, prescrito de acuerdo a las indicaciones de la UNE 138002 y rejuntadas con mortero de juntas cementoso de fraguado y endurecimiento rápido, <span class="resaltado">{mortero_nombre}</span> de <span class="resaltado">{mortero_fabricante}</span>, según EN 13888, para juntas de hasta <span class="resaltado">{junta_maxima}</span> mm.\n\nI/p.p medios auxiliares. Utilización de p/p de Crucetas Autonivelantes (no incluidas), formación de juntas perimetrales continuas, de anchura no menor de <span class="resaltado">{junta_perimetral}</span> mm, en los límites con paredes, pilares exentos y elevaciones de nivel y, en su caso, juntas de partición intermedias. Respetar juntas estructurales existentes en el soporte. Limpieza y comprobación del grado de humedad de la base. Replanteo de niveles. Replanteo de la disposición de las baldosas y juntas de movimiento. Aplicación del adhesivo. Colocación de las crucetas. Colocación de las baldosas con llana dentada y doble encolado. Relleno, si procede, de las juntas de partición intermedias. Rejuntado. Eliminación y limpieza del material sobrante. Limpieza inicial del pavimento al finalizar la obra y protección hasta entrega de obra. Todo el proceso de colocación se efectuará según indicaciones de la dirección facultativa y norma UNE 138002.`;

    // --- NAVEGACIÓN (SWITCH DE VISTAS) ---
    function goToSearchMode() {
        ui.viewDetail.classList.remove('active-view');
        ui.viewSearch.classList.add('active-view');
        // No limpiamos los filtros para que el usuario siga donde estaba
    }

    function goToDetailMode(productIndex) {
        selectedProductIndex = productIndex;
        const product = csvData[productIndex];
        
        if (product) {
            populateDetailView(product);
            ui.viewSearch.classList.remove('active-view');
            ui.viewDetail.classList.add('active-view');
        }
    }

    // --- RENDERIZADO DETALLE ---
    function populateDetailView(product) {
        // 1. Rellenar campos ocultos y visibles
        const productType = product['Desc_Familia_web'] || '';
        document.getElementById('tipo_material').value = productType;
        document.getElementById('coleccion').value = product['MODELO'] || '';
        document.getElementById('color').value = product['COLOR'] || '';
        document.getElementById('aspecto').value = [product['Efecto'], product['Acabado']].filter(Boolean).join(' / ');
        document.getElementById('dim_ancho').value = product['Ancho'] ? product['Ancho'].replace(',', '.') : '';
        document.getElementById('dim_alto').value = product['Alto'] ? product['Alto'].replace(',', '.') : '';
        document.getElementById('dim_espesor').value = product['Espesor(mm)'] ? product['Espesor(mm)'].replace(',', '.') : '';
        document.getElementById('destonificado').value = product['Variacion_cromatica'] || '';
        document.getElementById('absorcion_agua').value = product['iso_10545_3_absorcion_agua'] || '';
        document.getElementById('clase_resbaladicidad').value = product['en_16165_anexo_c_deslizamiento_pendulo'] || '';
        document.getElementById('valor_rd').value = product['(Rd)'] || '';
        document.getElementById('resistencia_manchas').value = product['Resistenci_ a_manchas'] || '';
        document.getElementById('resistencia_quimica').value = product['Resistencia_a_ataques_químicos'] || '';
        document.getElementById('modulo_rotura').value = product['iso_10545_4_resistencia_flexion'] || '';
        document.getElementById('carga_rotura').value = product['iso_10545_4_fuerza_rotura'] || '';
        
        // Valores por defecto editables
        document.getElementById('adhesivo_tipo').value = product['Adhesivo'] || 'C2';
        document.getElementById('junta_maxima').value = revestimientoTypes.includes(productType) ? "4" : "15";

        // 2. Imagen Principal
        const imageUrl = product['imagen_url_web'];
        if (imageUrl && imageUrl.trim() !== "") {
            ui.detailImage.src = imageUrl;
            ui.detailImage.style.display = 'block';
            ui.btnDescargarImagen.style.display = 'inline-flex';
        } else {
            ui.detailImage.src = ''; // o placeholder
            ui.detailImage.style.display = 'none';
            ui.btnDescargarImagen.style.display = 'none';
        }

        // 3. Links
        ui.linkDAP.href = product['declaracion_ambiental_producto'] || '#';
        ui.linkDOP.href = product['declaracion_prestaciones'] || '#';
        if (!product['declaracion_ambiental_producto']) ui.linkDAP.style.display = 'none'; else ui.linkDAP.style.display = 'inline-flex';
        if (!product['declaracion_prestaciones']) ui.linkDOP.style.display = 'none'; else ui.linkDOP.style.display = 'inline-flex';

        // 4. Generar Texto
        generarTexto();
    }

    function generarTexto() {
        if (selectedProductIndex === null) return;
        const values = {};
        for (let el of ui.formulario.elements) { if (el.id) values[el.id] = el.value; }
        
        const selectedProductType = values['tipo_material'];
        let activeTemplate = revestimientoTypes.includes(selectedProductType) ? revestimientoTemplate : pavimentoTemplate;
        
        let textoHTML = activeTemplate;
        for (const key in values) {
            textoHTML = textoHTML.replace(new RegExp(`{${key}}`, 'g'), values[key] || '[DATO NO ESPECIFICADO]');
        }
        ui.output.innerHTML = textoHTML;
    }

    // --- LÓGICA DE FILTROS (MODO BÚSQUEDA) ---
    function updateFiltersAndProductList() {
        // 1. Filtros Checkbox
        let filteredProducts = csvData.filter(product => {
            const is20mm = !document.getElementById('filtro-20mm').checked || (product['Espesor(mm)'] && product['Espesor(mm)'].startsWith('2'));
            const isExt = !document.getElementById('filtro-ext').checked || (product['Acabado'] && product['Acabado'].toUpperCase() === 'EXT');
            const isDup = !document.getElementById('filtro-dup').checked || (product['MODELO'] && product['MODELO'].toUpperCase().includes('DUP'));
            return is20mm && isExt && isDup;
        });
        
        // 2. Filtros Select
        const activeSelectFilters = {};
        Object.keys(ui.allSelectFilters).forEach(key => {
            if (ui.allSelectFilters[key].value) activeSelectFilters[key] = ui.allSelectFilters[key].value;
        });

        if (Object.keys(activeSelectFilters).length > 0) {
            filteredProducts = filteredProducts.filter(product => {
                return Object.keys(activeSelectFilters).every(key => product[key] === activeSelectFilters[key]);
            });
        }
        
        // 3. Actualizar Opciones Selects
        Object.keys(ui.allSelectFilters).forEach(currentKey => {
            const otherFilters = { ...activeSelectFilters };
            delete otherFilters[currentKey];
            
            const availableProducts = csvData.filter(product => {
                const quickFiltersPass = (!document.getElementById('filtro-20mm').checked || (product['Espesor(mm)'] && product['Espesor(mm)'].startsWith('2'))) &&
                                         (!document.getElementById('filtro-ext').checked || (product['Acabado'] && product['Acabado'].toUpperCase() === 'EXT')) &&
                                         (!document.getElementById('filtro-dup').checked || (product['MODELO'] && product['MODELO'].toUpperCase().includes('DUP')));
                const otherSelectsPass = Object.keys(otherFilters).every(key => product[key] === otherFilters[key]);
                return quickFiltersPass && otherSelectsPass;
            });
            
            repopulateSelectWithOptions(ui.allSelectFilters[currentKey], availableProducts);
        });

        // 4. Renderizar Lista
        renderProductList(filteredProducts);
        ui.statusMessage.textContent = `${filteredProducts.length} productos encontrados`;
    }
    
    function repopulateSelectWithOptions(selectElement, availableProducts) {
        const currentValue = selectElement.value;
        const csvCol = selectElement.dataset.csvCol;
        const counts = availableProducts.reduce((acc, product) => {
            const value = product[csvCol];
            if (value) acc[value] = (acc[value] || 0) + 1;
            return acc;
        }, {});
        
        const sortedOptions = Object.keys(counts).sort();
        selectElement.innerHTML = `<option value="">Todos (${availableProducts.length})</option>`;
        sortedOptions.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = `${value} (${counts[value]})`;
            if (value === currentValue) option.selected = true;
            selectElement.appendChild(option);
        });
    }

    function renderProductList(products) {
        ui.productResultsList.innerHTML = '';
        
        if (products.length === 0) {
            ui.productResultsList.innerHTML = `
                <div class="empty-search-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    <p>No se encontraron productos con estos filtros.</p>
                </div>`;
            return;
        }

        products.forEach(product => {
            const originalIndex = csvData.findIndex(p => p === product);
            
            // Crear tarjeta
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.index = originalIndex;
            
            // Miniatura
            const imgUrl = product['imagen_url_web'];
            let imgHTML = '<div class="card-no-thumb">Sin foto</div>';
            if (imgUrl && imgUrl.trim() !== "") {
                imgHTML = `<img src="${imgUrl}" class="card-thumb" alt="mini" loading="lazy" onerror="this.parentNode.innerHTML='<div class=\'card-no-thumb\'>Error</div>'">`;
            }

            // Tags
            const typeTag = product['Desc_Familia_web'] ? `<span class="tag">${product['Desc_Familia_web'].split(' ')[0]}</span>` : '';
            const classTag = product['en_16165_anexo_c_deslizamiento_pendulo'] ? `<span class="tag">C${product['en_16165_anexo_c_deslizamiento_pendulo']}</span>` : '';
            
            card.innerHTML = `
                <div class="card-thumb-container">${imgHTML}</div>
                <div class="card-info">
                    <h4 class="card-title">${product.MODELO || 'S/M'} - ${product.COLOR || 'S/C'}</h4>
                    <p class="card-sub">${product.FORMATO || ''} | ${product.Acabado || ''}</p>
                    <div class="card-tags">
                        ${typeTag}
                        ${classTag}
                        ${product['Espesor(mm)'] ? `<span class="tag">${product['Espesor(mm)']}mm</span>` : ''}
                    </div>
                </div>
            `;

            card.addEventListener('click', () => goToDetailMode(originalIndex));
            ui.productResultsList.appendChild(card);
        });
    }
    
    function clearFilters() {
         ui.quickFilters.forEach(qf => qf.checked = false);
         Object.values(ui.allSelectFilters).forEach(select => select.value = '');
         updateFiltersAndProductList();
    }

    // --- CARGA DATOS ---
    async function loadDataAndInitializeApp() {
        const csvFilePath = 'BD_contrac_presto3.csv'; 
        ui.statusMessage.textContent = 'Cargando CSV...';
        try {
            const response = await fetch(csvFilePath);
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            const csvText = await response.text();
            csvData = parseCSV(csvText);
            if (csvData.length === 0) throw new Error("CSV vacío o inválido.");
            
            Object.values(ui.allSelectFilters).forEach(select => { select.disabled = false; });
            updateFiltersAndProductList();
        } catch (error) {
            ui.statusMessage.textContent = `Error: No se pudo cargar el catálogo.`;
            console.error(error);
        }
    }

    function parseCSV(text) {
        const lines = text.trim().split(/\r\n|\n/);
        if (lines.length < 2) return [];
        const headerLine = lines[0].replace(/^\uFEFF/, '');
        const delimiter = (headerLine.match(/;/g) || []).length > (headerLine.match(/,/g) || []).length ? ';' : ',';
        const headers = headerLine.split(delimiter).map(h => h.trim());
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line === '') continue;
            const values = line.split(delimiter);
            if (values.length < headers.length) continue;
            const entry = {};
            headers.forEach((header, index) => entry[header] = values[index] ? values[index].trim() : '');
            data.push(entry);
        }
        return data;
    }

    // --- EXPORTACIÓN (PDF / TXT / IMG) ---
    async function generarPDF() {
        if (selectedProductIndex === null) return;
        
        const originalText = ui.btnDescargarPdf.textContent;
        ui.btnDescargarPdf.textContent = '...';
        ui.btnDescargarPdf.disabled = true;

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const product = csvData[selectedProductIndex];
            
            // Configuración
            const M_LEFT = 20, M_TOP = 20, WIDTH = 170;
            let y = M_TOP;

            // Helpers
            const imgToBase64 = async (url) => {
                if (!url) return null;
                try {
                    const res = await fetch(url);
                    const blob = await res.blob();
                    return new Promise((r) => {
                        const reader = new FileReader();
                        reader.onloadend = () => r(reader.result);
                        reader.readAsDataURL(blob);
                    });
                } catch { return null; }
            };

            // 1. Logo
            const logo = await imgToBase64('LOGO-PAMESA.jpg');
            if (logo) doc.addImage(logo, 'JPEG', M_LEFT, 10, 50, 10);

            // 2. Título Doc
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('Prescripción Técnica', 210 - 20, 16, { align: 'right' });
            y = 25;
            doc.setDrawColor(206, 23, 25); doc.line(M_LEFT, y, 210-20, y); y += 10;

            // 3. Título Producto
            doc.setFontSize(16); doc.setTextColor(206, 23, 25);
            doc.text(`${product.MODELO} - ${product.COLOR}`, M_LEFT, y);
            y += 10;

            // 4. Imagen Producto + Texto Ajustado
            const prodImg = await imgToBase64(ui.detailImage.src);
            let textX = M_LEFT;
            let textW = WIDTH;

            if (prodImg) {
                doc.addImage(prodImg, 'JPEG', M_LEFT, y, 60, 60);
                textX = M_LEFT + 65; 
                textW = WIDTH - 65;
            }

            // Procesar Texto HTML a PDF (Lógica manual para mantener negritas)
            const rawHTML = ui.output.innerHTML;
            const cleanText = rawHTML.replace(/<br\s*\/?>/gi, '\n').replace(/&nbsp;/g, ' ');
            const paragraphs = cleanText.split('\n');

            doc.setFontSize(9); doc.setTextColor(0,0,0);
            let currentY = y;
            
            paragraphs.forEach(para => {
                if (!para.trim()) { currentY += 4; return; }
                
                // Reset X si pasamos la altura de la imagen
                if (prodImg && currentY > (y + 65)) { textX = M_LEFT; textW = WIDTH; }

                // Parsear negritas (span class="resaltado")
                const parts = para.split(/(<span class="resaltado">.*?<\/span>)/g);
                let line = [];
                let lineWidth = 0;

                // Aplanar partes en palabras con estilo
                const words = [];
                parts.forEach(part => {
                    const isBold = part.startsWith('<span');
                    const content = isBold ? part.replace(/<[^>]+>/g, '') : part;
                    content.split(' ').forEach(w => {
                        if(w) words.push({ text: w + ' ', bold: isBold });
                    });
                });

                // Dibujar palabras
                words.forEach(wordObj => {
                    doc.setFont('helvetica', wordObj.bold ? 'bold' : 'normal');
                    doc.setTextColor(wordObj.bold ? '#ce1719' : '#333333');
                    const wWidth = doc.getStringUnitWidth(wordObj.text) * 9 / doc.internal.scaleFactor;

                    if (lineWidth + wWidth > textW) {
                        currentY += 4; // Nueva linea
                        lineWidth = 0;
                        if (prodImg && currentY > (y + 65)) { textX = M_LEFT; textW = WIDTH; } // Chequeo continuo
                        
                        // Salto de página
                        if (currentY > 280) {
                            doc.addPage();
                            currentY = 20;
                            textX = M_LEFT; textW = WIDTH;
                        }
                    }
                    
                    doc.text(wordObj.text, textX + lineWidth, currentY);
                    lineWidth += wWidth;
                });
                
                currentY += 5; // Margen párrafo
            });

            // Footer
            const pages = doc.internal.getNumberOfPages();
            for(let i=1; i<=pages; i++) {
                doc.setPage(i);
                doc.setFontSize(8); doc.setTextColor(150);
                doc.text(`Pág ${i}/${pages} | ${new Date().toLocaleDateString()}`, 105, 290, { align: 'center' });
            }

            const fname = `Prescripcion_${product.MODELO}_${product.COLOR}.pdf`;
            doc.save(fname);

        } catch (e) {
            console.error(e);
            alert('Error al generar PDF');
        } finally {
            ui.btnDescargarPdf.textContent = 'PDF';
            ui.btnDescargarPdf.disabled = false;
        }
    }

    // --- EVENTOS ---
    ui.btnBackSearch.addEventListener('click', goToSearchMode);
    
    ui.btnClearFilters.addEventListener('click', clearFilters);
    ui.quickFilters.forEach(el => el.addEventListener('change', updateFiltersAndProductList));
    Object.values(ui.allSelectFilters).forEach(el => el.addEventListener('change', updateFiltersAndProductList));
    
    Array.from(ui.formulario.elements).forEach(el => el.addEventListener('input', generarTexto));

    ui.btnCopiar.addEventListener('click', () => {
        navigator.clipboard.writeText(ui.output.textContent);
        const prev = ui.btnCopiar.textContent;
        ui.btnCopiar.textContent = '¡Copiado!';
        setTimeout(() => ui.btnCopiar.textContent = prev, 1500);
    });

    ui.btnDescargarTxt.addEventListener('click', () => {
        const blob = new Blob([ui.output.textContent], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'prescripcion.txt';
        a.click();
    });

    ui.btnDescargarPdf.addEventListener('click', generarPDF);

    ui.btnDescargarImagen.addEventListener('click', async () => {
        const url = ui.detailImage.src;
        if(!url) return;
        try {
            const res = await fetch(url);
            const blob = await res.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'imagen_producto.jpg';
            a.click();
        } catch {
            window.open(url, '_blank');
        }
    });

    // INICIO
    loadDataAndInitializeApp();
});
    </script>
</body>
</html>